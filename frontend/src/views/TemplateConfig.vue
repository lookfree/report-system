<template>
  <div class="template-config-page" v-loading="loading">
    <el-card>
      <template #header>
        <div class="card-header">
          <span>Ê®°ÊùøÈÖçÁΩÆ: {{ template?.name }}</span>
          <div>
            <el-button @click="$router.back()">ËøîÂõû</el-button>
            <el-button type="primary" @click="handleSaveConfig" :loading="saving">
              ‰øùÂ≠òÈÖçÁΩÆ
            </el-button>
          </div>
        </div>
      </template>
      
      <div v-if="template">
        <div v-for="section in template.structure.sections" :key="section.id" class="section-config">
          <!-- ÈªòËÆ§Ë°®Ê†º‰∏çÊòæÁ§∫Â§¥ÈÉ®‰ø°ÊÅØÈÖçÁΩÆ -->
          <div v-if="section.id !== 'default_header_table'" class="table-header-config" style="background: #f0f0f0; padding: 10px; margin: 10px 0; border-left: 4px solid #1890ff;">
            <div style="display: flex; align-items: center; justify-content: space-between; gap: 15px;">
              <div style="flex: 1; display: flex; align-items: center;">
                <label style="font-weight: bold; margin-right: 10px; white-space: nowrap;">ÂêçÁß∞:</label>
                <el-input 
                  v-model="tableNames[section.id]" 
                  style="flex: 1; max-width: 400px;" 
                  placeholder="ËØ∑ËæìÂÖ•Ë°®Ê†ºÂêçÁß∞"
                  size="small"
                />
                <h3 v-if="!tableNames[section.id]" style="margin-left: 15px; margin-right: 0; margin-top: 0; margin-bottom: 0; font-size: 16px; color: #666;">{{ section.title }}</h3>
              </div>
            </div>
            
            <!-- Â§áÊ≥®ÈÖçÁΩÆ -->
            <div style="margin-top: 15px;">
              <label style="font-weight: bold; margin-right: 10px;">Â§áÊ≥®:</label>
              <el-input 
                v-model="tableRemarks[section.id]"
                placeholder="ËØ∑ËæìÂÖ•Â§áÊ≥®"
                size="small"
                style="max-width: 400px;"
              />
            </div>
            
            <!-- ÁªüËÆ°ÈÖçÁΩÆ -->
            <div v-if="section.hasTable" style="margin-top: 15px; display: flex; align-items: center; gap: 10px;">
              <label style="font-weight: bold;">ÁªüËÆ°:</label>
              <el-switch 
                v-model="statisticsEnabled[section.id]"
                size="small"
              />
            </div>
            
          </div>
          
          <!-- Â¶ÇÊûúÊòØË°®Ê†ºÁ±ªÂûãÔºåÊòæÁ§∫Âä®ÊÄÅË°®Ê†ºÈÖçÁΩÆ -->
          <div v-if="section.hasTable && section.tableStructure?.headers?.length > 0">
            <el-alert 
              v-if="section.id !== 'default_header_table'"
              type="info" 
              :title="`Ê£ÄÊµãÂà∞Ë°®Ê†º (${section.tableStructure.rowCount} Ë°å √ó ${section.tableStructure.columnCount} Âàó)`"
              :closable="false"
              style="margin-bottom: 15px;"
            />
            
            <!-- Ë°®Ê†ºÈÖçÁΩÆ -->
            <div class="table-config">
              <div class="config-header">
                <h4>Ë°®Ê†ºÈÖçÁΩÆ</h4>
              </div>
              
              <!-- Ë°®Ê†ºÊìç‰ΩúÂ∑•ÂÖ∑Ê†è - ÁÆÄÂåñÁâà -->
              <div class="table-operations-simple">
                <div class="operation-buttons">
                  <el-button 
                    size="small" 
                    type="primary"
                    @click="toggleMergeMode(section.id)"
                    :class="{ 'merge-mode-active': mergeMode[section.id] }">
                    <el-icon><svg viewBox="0 0 1024 1024" width="16" height="16"><path d="M896 128H128c-35.3 0-64 28.7-64 64v640c0 35.3 28.7 64 64 64h768c35.3 0 64-28.7 64-64V192c0-35.3-28.7-64-64-64zM448 832H128V576h320v256zm0-320H128V256h320v256zm448 320H512V576h384v256zm0-320H512V256h384v256z"/></svg></el-icon>
                    {{ mergeMode[section.id] ? 'ÂèñÊ∂à' : 'ÂêàÂπ∂ÂçïÂÖÉÊ†º' }}
                  </el-button>
                  <el-button 
                    size="small" 
                    type="warning" 
                    @click="splitSelectedCell(section.id)"
                    :disabled="!hasSelectedMergedCell(section.id)">
                    <el-icon><svg viewBox="0 0 1024 1024" width="16" height="16"><path d="M896 128H128c-35.3 0-64 28.7-64 64v640c0 35.3 28.7 64 64 64h768c35.3 0 64-28.7 64-64V192c0-35.3-28.7-64-64-64zM192 768V576h256v192H192zm0-256V256h256v256H192zm320 256V576h256v192H512zm0-256V256h256v256H512z"/></svg></el-icon>
                    ÊãÜÂàÜÂçïÂÖÉÊ†º
                  </el-button>
                </div>
                <div class="operation-tips" v-if="mergeMode[section.id]">
                  <el-icon class="el-icon--primary" style="animation: pulse-border 1.5s ease-in-out infinite;">
                    <svg viewBox="0 0 1024 1024" width="16" height="16">
                      <path d="M512 64C264.6 64 64 264.6 64 512s200.6 448 448 448 448-200.6 448-448S759.4 64 512 64zm0 820c-205.4 0-372-166.6-372-372s166.6-372 372-372 372 166.6 372 372-166.6 372-372 372z"/>
                      <path d="M464 336a48 48 0 1 0 96 0 48 48 0 1 0-96 0zm72 112h-48c-4.4 0-8 3.6-8 8v272c0 4.4 3.6 8 8 8h48c4.4 0 8-3.6 8-8V456c0-4.4-3.6-8-8-8z"/>
                    </svg>
                  </el-icon>
                  <span style="margin-left: 8px; color: #52c41a; font-weight: 500;">
                    üñ±Ô∏è Êåâ‰ΩèÈº†Ê†áÊãñÊãΩÈÄâÊã©Ë¶ÅÂêàÂπ∂ÁöÑÂçïÂÖÉÊ†ºÂå∫Âüü
                  </span>
                </div>
              </div>


              <!-- Á∫ØÊï∞ÊçÆË°®Ê†ºÂÆûÁé∞ - Êó†Ë°®Â§¥Ê¶ÇÂøµ -->
              <div class="modern-table-container">
                <table class="modern-table data-table" :class="{ 'merge-mode-active-table': mergeMode[section.id] }">
                  <tbody>
                    <!-- ÊâÄÊúâË°åÈÉΩ‰Ωú‰∏∫Êï∞ÊçÆË°åÔºåÂåÖÊã¨ÂéüÊù•ÁöÑË°®Â§¥ -->
                    <tr v-for="(row, rowIndex) in getAllTableRows(section.id)" :key="rowIndex" 
                        :class="{ 'header-row': rowIndex < getHeaderRowCount(section.id) }">
                      <td v-for="(cellData, colIndex) in row" 
                          :key="colIndex"
                          v-show="!isCellHidden(section.id, rowIndex, colIndex)"
                          :id="`cell_${section.id}_${rowIndex}_${colIndex}`"
                          class="table-cell"
                          :class="getCellClass(section.id, rowIndex, colIndex)"
                          :colspan="getCellColspan(section.id, rowIndex, colIndex)"
                          :rowspan="getCellRowspan(section.id, rowIndex, colIndex)"
                          @mousedown="handleCellMouseDown(section.id, rowIndex, colIndex, $event)"
                          @mouseenter="handleCellMouseEnter(section.id, rowIndex, colIndex, $event)"
                          @mouseup="handleCellMouseUp(section.id, rowIndex, colIndex, $event)"
                          @click="handleCellClickEvent(section.id, rowIndex, colIndex, $event)"
                          @dblclick="handleCellDoubleClick(section.id, rowIndex, colIndex, $event)">
                        <input 
                          v-if="editingCell === `${section.id}_${rowIndex}_${colIndex}`"
                          v-model="editingValue"
                          class="cell-input"
                          @blur="confirmEdit(section.id, rowIndex, colIndex)"
                          @keyup.enter="confirmEdit(section.id, rowIndex, colIndex)"
                          @keyup.esc="cancelEdit"
                          ref="cellInput"
                        />
                        <span v-else>
                          {{ getCellDisplayContent(section.id, rowIndex, colIndex, cellData || '') }}
                        </span>
                      </td>
                    </tr>
                  </tbody>
                </table>
              </div>
              
              <!-- ÁªüËÆ°Ë°å -->
              <div v-if="statisticsEnabled[section.id] && section.id !== 'default_header_table'" class="statistics-container">
                <table class="statistics-table">
                  <thead>
                    <tr>
                      <th colspan="100%" class="stats-header">ÁªüËÆ°Ê±áÊÄª</th>
                    </tr>
                  </thead>
                  <tbody>
                    <tr>
                      <td v-for="(header, colIndex) in section.tableStructure?.headers || []"
                          :key="colIndex"
                          :id="`stats_cell_${section.id}_${colIndex}`"
                          class="stats-cell"
                          @click="handleStatsCellClick(section.id, colIndex)">
                        {{ getStatsContent(section.id, colIndex) }}
                      </td>
                    </tr>
                  </tbody>
                </table>
              </div>
            </div>
          </div>
          
          <!-- ÈùûË°®Ê†ºÁ±ªÂûãÁöÑÂ∏∏ËßÑÈÖçÁΩÆ -->
          <div v-else>
            <el-table :data="[getConfigForSection(section.id)]" style="width: 100%" border stripe>
              <el-table-column label="Êï∞ÊçÆÁ±ªÂûã" width="150">
                <template #default="{ row }">
                  <el-select v-model="row.dataType" placeholder="ÈÄâÊã©Á±ªÂûã">
                    <el-option label="Âõ∫ÂÆöÂÄº" value="FIXED" />
                    <el-option label="ÊâãÂä®Â°´ÂÜô" value="MANUAL" />
                    <el-option label="Âä®ÊÄÅËé∑Âèñ" value="DYNAMIC" />
                  </el-select>
                </template>
              </el-table-column>
              
              <el-table-column label="ÈÖçÁΩÆÂÜÖÂÆπ">
                <template #default="{ row }">
                  <!-- Fixed or Manual value -->
                  <el-input
                    v-if="row.dataType === 'FIXED' || row.dataType === 'MANUAL'"
                    v-model="row.value"
                    :placeholder="row.dataType === 'FIXED' ? 'ËæìÂÖ•Âõ∫ÂÆöÂÄº' : 'ËøêË°åÊó∂ÊâãÂä®Â°´ÂÜô'"
                    type="textarea"
                    :rows="2"
                  />
                  
                  <!-- Dynamic SQL -->
                  <div v-else-if="row.dataType === 'DYNAMIC'">
                    <el-select v-model="row.dataSourceId" placeholder="ÈÄâÊã©Êï∞ÊçÆÊ∫ê" style="width: 100%; margin-bottom: 10px;">
                      <el-option
                        v-for="ds in dataSources"
                        :key="ds.id"
                        :label="ds.name"
                        :value="ds.id"
                      />
                    </el-select>
                    <el-input
                      v-model="row.sqlQuery"
                      placeholder="ËæìÂÖ•SQLÊü•ËØ¢ËØ≠Âè•"
                      type="textarea"
                      :rows="3"
                    />
                    <el-button
                      v-if="row.dataSourceId && row.sqlQuery"
                      size="small"
                      style="margin-top: 10px;"
                      @click="testQuery(row)"
                    >
                      ÊµãËØïÊü•ËØ¢
                    </el-button>
                  </div>
                </template>
              </el-table-column>
            </el-table>
          </div>
        </div>
      </div>
    </el-card>
    
    <!-- Query Test Dialog -->
    <el-dialog v-model="showTestDialog" title="Êü•ËØ¢ÊµãËØïÁªìÊûú" width="600px">
      <div v-loading="testing">
        <el-alert v-if="testResult.error" type="error" :title="testResult.error" show-icon />
        <div v-else-if="testResult.data">
          <el-alert type="success" title="Êü•ËØ¢ÊàêÂäü" show-icon :closable="false" />
          <p style="margin: 10px 0;">ËøîÂõû {{ testResult.rowCount }} Ë°åÊï∞ÊçÆ</p>
          <el-table :data="testResult.sample" size="small" max-height="300" border stripe>
            <el-table-column
              v-for="(val, key) in testResult.sample[0]"
              :key="key"
              :prop="key"
              :label="key"
            >
            </el-table-column>
          </el-table>
        </div>
      </div>
    </el-dialog>

    <!-- ÂçïÂÖÉÊ†ºÈÖçÁΩÆÂºπÁ™ó -->
    <el-dialog v-model="showCellConfigDialog" title="ÂçïÂÖÉÊ†ºÈÖçÁΩÆ" width="800px">
      <el-form :model="cellConfig" label-width="100px">
        <!-- Â±ïÁ§∫ÂÜÖÂÆπ -->
        <el-form-item label="Â±ïÁ§∫ÂÜÖÂÆπ">
          <el-radio-group v-model="cellConfig.displayType">
            <el-radio label="text">‰ªÖÊñáÂ≠ó</el-radio>
            <el-radio label="dataset">Êï∞ÊçÆÈõÜ</el-radio>
          </el-radio-group>
        </el-form-item>

        <!-- ‰ªÖÊñáÂ≠óÊ®°Âºè -->
        <div v-if="cellConfig.displayType === 'text'">
          <el-form-item label="ÊñáÂ≠óÂÜÖÂÆπ">
            <el-input v-model="cellConfig.textContent" placeholder="ËØ∑ËæìÂÖ•ÊñáÂ≠óÂÜÖÂÆπ" />
          </el-form-item>
        </div>

        <!-- Êï∞ÊçÆÈõÜÊ®°Âºè -->
        <div v-if="cellConfig.displayType === 'dataset'">
          <el-form-item label="Êï∞ÊçÆÈõÜ">
            <el-select v-model="cellConfig.datasetId" placeholder="ËØ∑ÈÄâÊã©" style="width: 200px;">
              <el-option
                v-for="ds in dataSources"
                :key="ds.id"
                :label="ds.name"
                :value="ds.id"
              />
            </el-select>
          </el-form-item>

          <el-form-item label="Êï∞ÊçÆÁªìÊûÑ">
            <el-radio-group v-model="cellConfig.dataStructure">
              <el-radio label="single">ÂçïÊù°</el-radio>
              <el-radio label="list" :disabled="isMergedCell || isHiddenCell">ÂàóË°®</el-radio>
            </el-radio-group>
            <div v-if="isMergedCell || isHiddenCell" class="field-tip">
              <el-text type="warning" size="small">
                <el-icon><Warning /></el-icon>
                ÂêàÂπ∂ÂçïÂÖÉÊ†º‰∏çÊîØÊåÅÂàóË°®Ê®°Âºè
              </el-text>
            </div>
          </el-form-item>

          <!-- ÂàóË°®Ê®°ÂºèÁöÑsheetÈ°µÈÖçÁΩÆ -->
          <div v-if="cellConfig.dataStructure === 'list'">
            <el-form-item label="sheetÈ°µÈÖçÁΩÆ">
              <el-radio-group v-model="cellConfig.sheetConfig">
                <el-radio label="current">ÂΩìÂâçsheetÈ°µ</el-radio>
                <el-radio label="separate">ÂçïÁã¨sheetÈ°µ</el-radio>
              </el-radio-group>
            </el-form-item>
          </div>

          <el-form-item label="Â±ïÁ§∫Â≠óÊÆµ" v-if="cellConfig.dataStructure === 'single' || cellConfig.dataStructure === 'list'">
            <el-select 
              v-model="cellConfig.displayFields" 
              multiple
              placeholder="ËØ∑ÈÄâÊã©Â≠óÊÆµÔºàÂèØÂ§öÈÄâÔºâ" 
              style="width: 400px;"
              :max-collapse-tags="3"
              collapse-tags
              collapse-tags-tooltip
            >
              <el-option-group label="Áî®Êà∑ÊùÉÈôêÂ≠óÊÆµ">
                <el-option label="Êï∞ÊçÆÊâπÊ¨°(Â≠óÁ¨¶‰∏≤)" value="data_batch" />
                <el-option label="ÁªÑÁªáÁºñÂè∑(Â≠óÁ¨¶‰∏≤)" value="org_code" />
                <el-option label="ÁªÑÁªáÂêçÁß∞(Â≠óÁ¨¶‰∏≤)" value="org_name" />
                <el-option label="Áà∂Á∫ßÊú∫ÊûÑÁºñÂè∑(Â≠óÁ¨¶‰∏≤)" value="parent_org_code" />
                <el-option label="ÂßìÂêç(Â≠óÁ¨¶‰∏≤)" value="person_name" />
                <el-option label="‰∏ªË¥¶Âè∑Á±ªÂûã(Â≠óÁ¨¶‰∏≤)" value="account_type" />
                <el-option label="ÁîµËØù(Â≠óÁ¨¶‰∏≤)" value="phone" />
                <el-option label="ÂΩïÂÖ•Êó∂Èó¥(Â≠óÁ¨¶‰∏≤)" value="entry_time" />
              </el-option-group>
              <el-option-group label="Á≥ªÁªüÊó•ÂøóÂ≠óÊÆµ">
                <el-option label="Êó•ÂøóID(Â≠óÁ¨¶‰∏≤)" value="log_id" />
                <el-option label="Êó•ÂøóÊó∂Èó¥(Êó∂Èó¥)" value="log_time" />
                <el-option label="Êó•ÂøóÁ∫ßÂà´(Â≠óÁ¨¶‰∏≤)" value="log_level" />
                <el-option label="Ê®°ÂùóÂêçÁß∞(Â≠óÁ¨¶‰∏≤)" value="module" />
                <el-option label="Êó•ÂøóÊ∂àÊÅØ(Â≠óÁ¨¶‰∏≤)" value="message" />
                <el-option label="IPÂú∞ÂùÄ(Â≠óÁ¨¶‰∏≤)" value="ip_address" />
                <el-option label="ÂéüÂßãÊó•Âøó(Â≠óÁ¨¶‰∏≤)" value="originalLog" />
              </el-option-group>
              <el-option-group label="‰∏öÂä°Êï∞ÊçÆÂ≠óÊÆµ">
                <el-option label="‰∏öÂä°ID(Â≠óÁ¨¶‰∏≤)" value="business_id" />
                <el-option label="ÂÆ¢Êà∑ÂêçÁß∞(Â≠óÁ¨¶‰∏≤)" value="customer_name" />
                <el-option label="ÂêàÂêåÈáëÈ¢ù(Êï∞Â≠ó)" value="contract_amount" />
                <el-option label="ÂêàÂêåÊó•Êúü(Êó•Êúü)" value="contract_date" />
                <el-option label="Áä∂ÊÄÅ(Â≠óÁ¨¶‰∏≤)" value="status" />
                <el-option label="Ë¥üË¥£‰∫∫(Â≠óÁ¨¶‰∏≤)" value="manager" />
                <el-option label="ÈÉ®Èó®(Â≠óÁ¨¶‰∏≤)" value="department" />
              </el-option-group>
              <el-option-group label="Ë¥¢Âä°Êï∞ÊçÆÂ≠óÊÆµ">
                <el-option label="Ë¥¶Êà∑‰ª£Á†Å(Â≠óÁ¨¶‰∏≤)" value="account_code" />
                <el-option label="Ë¥¶Êà∑ÂêçÁß∞(Â≠óÁ¨¶‰∏≤)" value="account_name" />
                <el-option label="‰ΩôÈ¢ù(Êï∞Â≠ó)" value="balance" />
                <el-option label="Ë¥ßÂ∏ÅÁ±ªÂûã(Â≠óÁ¨¶‰∏≤)" value="currency" />
                <el-option label="Êõ¥Êñ∞Êó∂Èó¥(Êó•Êúü)" value="last_update" />
                <el-option label="Ë¥¶Êà∑Á±ªÂûã(Â≠óÁ¨¶‰∏≤)" value="account_type" />
              </el-option-group>
              <el-option-group label="‰∫∫‰∫ãÊï∞ÊçÆÂ≠óÊÆµ">
                <el-option label="ÂëòÂ∑•ID(Â≠óÁ¨¶‰∏≤)" value="employee_id" />
                <el-option label="ÂëòÂ∑•ÂßìÂêç(Â≠óÁ¨¶‰∏≤)" value="employee_name" />
                <el-option label="ÈÉ®Èó®ÂêçÁß∞(Â≠óÁ¨¶‰∏≤)" value="department" />
                <el-option label="ËÅå‰Ωç(Â≠óÁ¨¶‰∏≤)" value="position" />
                <el-option label="ÂÖ•ËÅåÊó•Êúü(Êó•Êúü)" value="hire_date" />
                <el-option label="Ëñ™ËµÑ(Êï∞Â≠ó)" value="salary" />
                <el-option label="ÂëòÂ∑•Áä∂ÊÄÅ(Â≠óÁ¨¶‰∏≤)" value="status" />
              </el-option-group>
            </el-select>
          </el-form-item>

          <el-form-item label="Â≠óÊÆµÈ¢ÑËßà" v-if="cellConfig.displayFields && cellConfig.displayFields.length > 0">
            <!-- ÂàóË°®Ê®°ÂºèÔºöË°®Ê†ºÈ¢ÑËßà -->
            <div class="field-preview-table" v-if="cellConfig.dataStructure === 'list'">
              <el-table 
                :data="getPreviewData()" 
                style="width: 100%; max-height: 200px;" 
                size="small"
                border
                stripe
              >
                <el-table-column 
                  v-for="field in cellConfig.displayFields" 
                  :key="field"
                  :prop="field"
                  :label="getFieldLabel(field)"
                  :width="120"
                  show-overflow-tooltip
                />
              </el-table>
              <p class="preview-note">
                <el-icon><Document /></el-icon>
                Â∑≤ÈÄâÊã© {{ cellConfig.displayFields.length }} ‰∏™Â≠óÊÆµÔºåÈ¢ÑËßàÂâç 3 Êù°Êï∞ÊçÆ
              </p>
            </div>
            
            <!-- ÂçïÊù°Ê®°ÂºèÔºöÂ≠óÊÆµÂÄºÈ¢ÑËßà -->
            <div class="field-preview-single" v-if="cellConfig.dataStructure === 'single'">
              <div class="single-data-preview">
                <div 
                  v-for="field in cellConfig.displayFields" 
                  :key="field"
                  class="field-item"
                >
                  <span class="field-label">{{ getFieldLabel(field) }}Ôºö</span>
                  <span class="field-value">{{ getSingleFieldValue(field) }}</span>
                </div>
              </div>
              <p class="preview-note">
                <el-icon><Document /></el-icon>
                Â∑≤ÈÄâÊã© {{ cellConfig.displayFields.length }} ‰∏™Â≠óÊÆµÔºåÂçïÊù°Êï∞ÊçÆÈ¢ÑËßà
              </p>
            </div>
          </el-form-item>
        </div>
      </el-form>

      <template #footer>
        <span class="dialog-footer">
          <el-button @click="showCellConfigDialog = false">ÂèñÊ∂à</el-button>
          <el-button type="primary" @click="confirmCellConfig">Á°ÆÂÆö</el-button>
        </span>
      </template>
    </el-dialog>
  </div>
</template>

<script setup>
import { ref, onMounted, nextTick, onUnmounted, watch } from 'vue'
import { useRoute } from 'vue-router'
import { ElMessage } from 'element-plus'
import { Plus, Delete, Document, Warning } from '@element-plus/icons-vue'
import RevoGrid from '@revolist/vue3-datagrid'
import { useTableConfig } from '@/composables/useTableConfig'
import { useTemplateConfig } from '@/composables/useTemplateConfig'
import { useGridHelpers } from '@/composables/useGridHelpers'
import api from '@/api'

const route = useRoute()
const templateId = ref(route.params.id)

// ‰ΩøÁî®composable

const {
  contentRows,
  getContentRows,
  onContentRowChange
} = useTableConfig()

const {
  template,
  loading,
  saving,
  configs,
  dataSources,
  showTestDialog,
  testing,
  testResult,
  getConfigForSection,
  onColumnConfigChange,
  resetTableData,
  loadDataSources,
  saveConfig,
  testQuery,
  testColumnQuery,
  loadTemplate
} = useTemplateConfig()

const {
  hasMergedHeaders,
  getMergedHeaderGroups,
  getGridColumns,
  getGridData,
  onCellEdit,
  onBeforeEdit,
  onRowHeaderClick,
  onColHeaderClick
} = useGridHelpers()

// Êñ∞Â¢ûÁöÑÂìçÂ∫îÂºèÊï∞ÊçÆ
const tableNames = ref({})
const tableDataSources = ref({})
const tableRemarks = ref({})
const statisticsEnabled = ref({})
// ÂçïÂÖÉÊ†ºÈÖçÁΩÆÂ≠òÂÇ®
const cellConfigurations = ref({})
// ÁªüËÆ°Ë°åÈÖçÁΩÆÂ≠òÂÇ®
const statisticsConfigurations = ref({})
// ÈÄâ‰∏≠ÁöÑÂçïÂÖÉÊ†º
const selectedCells = ref({})
// ÂêàÂπ∂ÁöÑÂçïÂÖÉÊ†º‰ø°ÊÅØ
const mergedCells = ref({})
// ÂêàÂπ∂Ê®°ÂºèÁä∂ÊÄÅ
const mergeMode = ref({})
// Ê°ÜÈÄâËµ∑Âßã‰ΩçÁΩÆ
const dragStart = ref(null)
// Ê°ÜÈÄâÁªìÊùü‰ΩçÁΩÆ
const dragEnd = ref(null)


// ÂçïÂÖÉÊ†ºÈÖçÁΩÆÂºπÁ™óÁõ∏ÂÖ≥
const showCellConfigDialog = ref(false)
const selectedCellInfo = ref(null)
const isMergedCell = ref(false)
const isHiddenCell = ref(false) // ÊòØÂê¶‰∏∫Ë¢´ÂêàÂπ∂ÁöÑÂçïÂÖÉÊ†ºÔºàÈùû‰∏ªÂçïÂÖÉÊ†ºÔºâ
const cellConfig = ref({
  displayType: 'text', // 'text' | 'dataset'
  textContent: '', // ‰ªÖÊñáÂ≠óÊ®°ÂºèÁöÑÂÜÖÂÆπ
  datasetId: '', // Êï∞ÊçÆÈõÜID
  dataStructure: 'single', // 'single' | 'list' | 'attachment'
  sheetConfig: 'current', // 'current' | 'separate'
  displayFields: [], // Â±ïÁ§∫Â≠óÊÆµÊï∞ÁªÑÔºàÊîØÊåÅÂ§öÈÄâÔºâ
  displayField: '', // ‰øùÊåÅÂêëÂêéÂÖºÂÆπ
  // ‰øùÊåÅÂêëÂêéÂÖºÂÆπ
  fillType: '',
  fixedValue: '',
  linkedField: ''
})

// ÁõëÂê¨templateÂèòÂåñÔºåËá™Âä®Â°´ÂÖÖË°®Ê†ºÂêçÁß∞
watch(template, (newTemplate) => {
  if (newTemplate && newTemplate.structure && newTemplate.structure.sections) {
    const names = {}
    newTemplate.structure.sections.forEach(section => {
      if (section.hasTable && section.title) {
        names[section.id] = section.title
      }
    })
    tableNames.value = names
  }
}, { immediate: true })

// ‰ªé‰øùÂ≠òÁöÑÈÖçÁΩÆ‰∏≠ÊÅ¢Â§çÊï∞ÊçÆ
const restoreConfigData = () => {
  if (!configs.value || configs.value.length === 0) return
  
  // ÊÅ¢Â§çË°®Ê†ºÂêçÁß∞
  const tableNameConfigs = configs.value.filter(c => c.sectionId.endsWith('_name'))
  tableNameConfigs.forEach(config => {
    const sectionId = config.parentSectionId
    if (sectionId) {
      tableNames.value[sectionId] = config.value
    }
  })
  
  // ÊÅ¢Â§çÊï∞ÊçÆÊ∫êÈÖçÁΩÆ
  const dataSourceConfigs = configs.value.filter(c => c.sectionId.endsWith('_datasource'))
  dataSourceConfigs.forEach(config => {
    const sectionId = config.parentSectionId
    if (sectionId) {
      tableDataSources.value[sectionId] = config.value
    }
  })
  
  // ÊÅ¢Â§çÂ§áÊ≥®ÈÖçÁΩÆ
  const remarkConfigs = configs.value.filter(c => c.sectionId.endsWith('_remark'))
  remarkConfigs.forEach(config => {
    const sectionId = config.parentSectionId
    if (sectionId) {
      tableRemarks.value[sectionId] = config.value
    }
  })
  
  // ÊÅ¢Â§çÁªüËÆ°ÂºÄÂÖ≥ÈÖçÁΩÆ
  const statsConfigs = configs.value.filter(c => c.sectionId.endsWith('_stats'))
  statsConfigs.forEach(config => {
    const sectionId = config.parentSectionId
    if (sectionId) {
      statisticsEnabled.value[sectionId] = config.value === 'true'
    }
  })
  
  // Ê∏ÖÁ©∫ÂéüÊúâÂçïÂÖÉÊ†ºÈÖçÁΩÆ
  cellConfigurations.value = {}
  
  // ÊÅ¢Â§çÂçïÂÖÉÊ†ºÈÖçÁΩÆ
  const cellConfigs = configs.value.filter(c => c.sectionId.startsWith('cell_'))
  cellConfigs.forEach(config => {
    const cellKey = config.sectionId.replace('cell_', '')
    const [sectionId, rowIndex, colIndex] = cellKey.split('_')
    
    // Áªü‰∏ÄÈÖçÁΩÆÊ†ºÂºè
    const configData = {
      displayType: config.dataType === 'FIXED' ? 'text' : 'dataset',
      textContent: config.dataType === 'FIXED' ? config.value || '' : '',
      datasetId: config.dataType === 'DYNAMIC' ? (config.dataSourceId || '1') : '',
      dataStructure: 'single',
      sheetConfig: 'current',
      displayFields: [],
      displayField: '',
      
      // ‰øùÊåÅÂÖºÂÆπÊÄßÂ≠óÊÆµ
      fillType: config.dataType === 'FIXED' ? 'fixed' : 'auto',
      fixedValue: config.value || '',
      linkedField: ''
    }
    
    // Ëß£ÊûêÊï∞ÊçÆÈõÜÈÖçÁΩÆ
    if (config.dataType === 'DYNAMIC' && config.value && config.value.includes('|')) {
      const [structure, fieldsStr] = config.value.split('|')
      configData.dataStructure = structure || 'single'
      if (fieldsStr && fieldsStr.includes(',')) {
        configData.displayFields = fieldsStr.split(',').map(f => f.trim())
      } else if (fieldsStr) {
        configData.displayFields = [fieldsStr.trim()]
      }
      configData.displayField = configData.displayFields[0] || ''
      configData.linkedField = configData.displayField
    }
    
    cellConfigurations.value[cellKey] = configData
    
    // È°µÈù¢ÊòæÁ§∫ÈÄöËøá getCellDisplayContent ÂáΩÊï∞Â§ÑÁêÜÔºåÊó†ÈúÄÊâãÂä®Êõ¥Êñ∞DOM
  })
  
  // ÊÅ¢Â§çÁªüËÆ°Ë°åÈÖçÁΩÆ
  const statsRowConfigs = configs.value.filter(c => c.sectionId.startsWith('stats_'))
  statsRowConfigs.forEach(config => {
    const cellKey = config.sectionId
    const [, sectionId, colIndex] = cellKey.split('_')
    
    statisticsConfigurations.value[cellKey] = {
      fillType: config.dataType === 'FIXED' ? 'fixed' : 'auto',
      fixedValue: config.value || '',
      linkedField: config.sqlQuery ? config.sqlQuery.replace('SELECT ', '').replace(' FROM table', '') : ''
    }
    
    // Á®çÂêéÊõ¥Êñ∞ÁªüËÆ°Ë°åÊòæÁ§∫ÔºàÈúÄË¶ÅÁ≠âÂæÖDOMÊ∏≤ÊüìÔºâ
    setTimeout(() => {
      const statsElement = document.getElementById(`stats_cell_${sectionId}_${colIndex}`)
      if (statsElement) {
        const displayContent = config.dataType === 'FIXED' ? config.value : 'Ëá™Âä®Ê±áÊÄª'
        statsElement.textContent = displayContent
        
        if (config.dataType === 'FIXED') {
          statsElement.style.backgroundColor = '#e6f7ff'
          statsElement.style.color = '#1890ff'
        } else {
          statsElement.style.backgroundColor = '#f0f9ff'
          statsElement.style.color = '#52c41a'
        }
      }
    }, 100)
  })
  
  // ÊÅ¢Â§çÂêàÂπ∂ÂçïÂÖÉÊ†º‰ø°ÊÅØ
  const mergeConfigs = configs.value.filter(c => c.sectionId.startsWith('merge_'))
  mergedCells.value = {}
  
  console.log('ÂºÄÂßãÊÅ¢Â§çÂêàÂπ∂ÂçïÂÖÉÊ†º‰ø°ÊÅØÔºåÊâæÂà∞ÈÖçÁΩÆ:', mergeConfigs.length, '‰∏™')
  
  mergeConfigs.forEach(config => {
    try {
      // Ëß£ÊûêsectionIdÔºåÂ§ÑÁêÜÂ§öÁßçÊ†ºÂºè:
      // 1. merge_table_section_0_3_0 (ÂÆåÊï¥Ê†ºÂºè)
      // 2. merge_table_0_0 (ÁÆÄÂåñÊ†ºÂºè)
      // 3. merge_table_3_0 (ÁÆÄÂåñÊ†ºÂºè)
      const parts = config.sectionId.split('_')
      
      let sectionId, mergeKey
      
      if (parts.length >= 3 && parts[0] === 'merge') {
        if (parts[1] === 'table' && parts.length >= 4) {
          // Ê†ºÂºè: merge_table_xxx Êàñ merge_table_section_xxx
          if (parts[2] === 'section') {
            // merge_table_section_0_3_0 -> sectionId: table_section_0, mergeKey: 3_0
            sectionId = `table_section_${parts[3]}`
            mergeKey = parts.slice(4).join('_')
          } else {
            // merge_table_3_0 -> sectionId: table_section_0, mergeKey: 3_0
            // ÂÅáËÆæÈªòËÆ§ÊòØ table_section_0
            sectionId = 'table_section_0'
            mergeKey = parts.slice(2).join('_')
          }
        } else {
          // Ê†áÂáÜÊ†ºÂºè: merge_sectionId_mergeKey
          sectionId = parts[1]
          mergeKey = parts.slice(2).join('_')
        }
        
        // Ëß£ÊûêÂêàÂπ∂‰ø°ÊÅØ
        const mergeInfo = JSON.parse(config.value)
        
        if (!mergedCells.value[sectionId]) {
          mergedCells.value[sectionId] = {}
        }
        
        // ‰∏∫ÂêàÂπ∂Âå∫ÂüüÁöÑÊâÄÊúâÂçïÂÖÉÊ†ºËÆæÁΩÆÂêàÂπ∂‰ø°ÊÅØ
        for (let row = mergeInfo.startRow; row < mergeInfo.startRow + mergeInfo.rowspan; row++) {
          for (let col = mergeInfo.startCol; col < mergeInfo.startCol + mergeInfo.colspan; col++) {
            const cellKey = `${row}_${col}`
            mergedCells.value[sectionId][cellKey] = {
              startRow: mergeInfo.startRow,
              startCol: mergeInfo.startCol,
              rowspan: mergeInfo.rowspan,
              colspan: mergeInfo.colspan
            }
          }
        }
        
      } else {
        console.warn('Êó†Ê≥ïËß£ÊûêÂêàÂπ∂ÂçïÂÖÉÊ†ºÈÖçÁΩÆÊ†ºÂºè:', config.sectionId)
      }
    } catch (error) {
      console.warn('ÊÅ¢Â§çÂêàÂπ∂ÂçïÂÖÉÊ†ºÈÖçÁΩÆÂ§±Ë¥•:', config.sectionId, error)
    }
  })
  
  // Â¶ÇÊûúÊ≤°Êúâ‰øùÂ≠òËøáÁöÑÂêàÂπ∂ÈÖçÁΩÆÔºå‰ªéÊ®°ÁâàÁªìÊûÑ‰∏≠ÁîüÊàêÂàùÂßãÂêàÂπ∂ÈÖçÁΩÆÔºà‰ªÖÁî®‰∫éË°®Â§¥Ë°åÔºâ
  if (mergeConfigs.length === 0 && template.value?.structure?.sections) {
    template.value.structure.sections.forEach(section => {
      if (section.hasTable && section.tableStructure?.headers) {
        initializeHeaderMergedCells(section.id)
      }
    })
  }
  
  // Âº∫Âà∂Ëß¶ÂèëVueÈáçÊñ∞Ê∏≤ÊüìÔºåÁ°Æ‰øùÂêàÂπ∂ÂçïÂÖÉÊ†ºÊ†∑ÂºèÁîüÊïà
  if (Object.keys(mergedCells.value).length > 0) {
    nextTick(() => {
      // ÂêàÂπ∂ÂçïÂÖÉÊ†ºÊ†∑ÂºèÁîüÊïà
    })
  }
  
  // ÊÅ¢Â§çÈÖçÁΩÆÊï∞ÊçÆÂÆåÊàê
}

// ÊÅ¢Â§çË°®Ê†ºÊï∞ÊçÆ
const restoreTableData = (template, getContentRows) => {
  if (!template?.structure?.sections) return
  
  // ÂºÄÂßãÊÅ¢Â§çË°®Ê†ºÊï∞ÊçÆ
  
  template.structure.sections.forEach(section => {
    if (section.hasTable && section.tableData) {
      
      // Ê∏ÖÁ©∫Áé∞ÊúâÊï∞ÊçÆ
      const currentRows = getContentRows(section.id)
      currentRows.splice(0, currentRows.length)
      
      // Ëé∑ÂèñÂΩìÂâçË°®Â§¥ÂàóÊï∞ÔºàËøôÊòØÊâ©Â±ïÂêéÁöÑÂàóÊï∞Ôºâ
      const expectedColumnCount = section.tableStructure?.headers?.length || 0
      console.log(`Ë°®Ê†º ${section.id} ÊúüÊúõÂàóÊï∞: ${expectedColumnCount}`)
      
      // ÊÅ¢Â§ç‰øùÂ≠òÁöÑÊï∞ÊçÆÔºåÁ°Æ‰øùË°åÊï∞ÊçÆ‰∏éÊâ©Â±ïÂêéÁöÑË°®Â§¥ÂåπÈÖç
      section.tableData.forEach(savedRow => {
        const cells = savedRow.cells || []
        
        // Á°Æ‰øùÊØèË°åÁöÑÂçïÂÖÉÊ†ºÊï∞Èáè‰∏éÊâ©Â±ïÂêéÁöÑË°®Â§¥Êï∞ÈáèÂåπÈÖç
        while (cells.length < expectedColumnCount - 1) { // -1 Âõ†‰∏∫Á¨¨‰∏ÄÂàóÈÄöÂ∏∏ÊòØÂêçÁß∞Âàó
          cells.push('') // Áî®Á©∫Â≠óÁ¨¶‰∏≤Â°´ÂÖÖÊñ∞Â¢ûÁöÑÂàó
        }
        
        currentRows.push({
          name: savedRow.name || '',
          type: savedRow.type || 'data',
          cells: cells,
          locked: savedRow.locked || false
        })
      })
      
      // Á°Æ‰øùË°®Ê†ºÁªìÊûÑÁöÑË°åÊï∞ÂíåÂàóÊï∞‰∏éÂÆûÈôÖÊï∞ÊçÆ‰∏ÄËá¥
      if (section.tableStructure) {
        section.tableStructure.rowCount = currentRows.length
        section.tableStructure.columnCount = expectedColumnCount
      }
      
      console.log(`Ë°®Ê†º ${section.id} Êï∞ÊçÆÊÅ¢Â§çÂÆåÊàêÔºåÂÖ± ${currentRows.length} Ë°åÔºåÊØèË°å ${expectedColumnCount} Âàó`)
      console.log(`Ë°®Ê†º ${section.id} ÁªìÊûÑÂêåÊ≠•ÔºörowCount=${section.tableStructure?.rowCount}, columnCount=${section.tableStructure?.columnCount}`)
    }
  })
  
  console.log('ÊâÄÊúâË°®Ê†ºÊï∞ÊçÆÂíåÁªìÊûÑÊÅ¢Â§çÂÆåÊàê')
}


onMounted(() => {
  loadTemplate(templateId.value, getContentRows, (template, getContentRows) => {
    // RevoGrid‰ºöËá™Âä®Ê∏≤ÊüìÔºåÊó†ÈúÄÊâãÂä®ÂàùÂßãÂåñ
    console.log('Template loaded, RevoGrid will render automatically')
    
    // ÊÅ¢Â§ç‰øùÂ≠òÁöÑË°®Ê†ºÊï∞ÊçÆ
    restoreTableData(template, getContentRows)
    
    // ÂêàÂπ∂ÂçïÂÖÉÊ†º‰ø°ÊÅØÂ∞Ü‰ªéÂêéÂè∞‰øùÂ≠òÁöÑÈÖçÁΩÆ‰∏≠ÊÅ¢Â§çÔºå‰∏çÂÜç‰ΩøÁî®Ê®°ÁâàheaderÁªìÊûÑÂàùÂßãÂåñ
    console.log('üöÄ Ë°®Ê†ºÂä†ËΩΩÂÆåÊàêÔºåÂêàÂπ∂ÂçïÂÖÉÊ†º‰ø°ÊÅØÂ∞Ü‰ªéÈÖçÁΩÆÊï∞ÊçÆ‰∏≠ÊÅ¢Â§ç')
    
    // Âª∂ËøüÊÅ¢Â§çÈÖçÁΩÆÊï∞ÊçÆÔºåÁ°Æ‰øùË°®Ê†ºÂ∑≤Ê∏≤Êüì
    setTimeout(() => {
      restoreConfigData()
    }, 500)
  })
  loadDataSources()
})

onUnmounted(() => {
  // RevoGrid‰ºöËá™Âä®Ê∏ÖÁêÜÔºåÊó†ÈúÄÊâãÂä®ÈîÄÊØÅ
  console.log('Component unmounting, RevoGrid will auto cleanup')
})

// ÂçïÂÖÉÊ†ºÈÖçÁΩÆÁõ∏ÂÖ≥ÊñπÊ≥ï
const openCellConfigDialog = (sectionId, rowIndex, colIndex, cellData) => {
  selectedCellInfo.value = {
    sectionId,
    rowIndex,
    colIndex
  }
  
  // Ê£ÄÊü•ÂçïÂÖÉÊ†ºÊòØÂê¶Ë¢´ÂêàÂπ∂
  isMergedCell.value = isCellMerged(sectionId, rowIndex, colIndex)
  // Ê£ÄÊü•ÂçïÂÖÉÊ†ºÊòØÂê¶Ë¢´ÈöêËóèÔºàË¢´ÂêàÂπ∂ÁöÑÂçïÂÖÉÊ†ºÔºâ
  isHiddenCell.value = isCellHidden(sectionId, rowIndex, colIndex)
  
  // ÂàùÂßãÂåñÂºπÁ™óÊï∞ÊçÆ
  if (cellData) {
    console.log('Êî∂Âà∞ÁöÑcellData:', cellData)
    
    // Á°Æ‰øù displayFields ÂßãÁªàÊòØÊï∞ÁªÑ
    let displayFields = []
    if (cellData.displayFields && Array.isArray(cellData.displayFields)) {
      displayFields = cellData.displayFields
    } else if (cellData.displayField) {
      displayFields = [cellData.displayField]
    } else if (cellData.linkedField) {
      displayFields = [cellData.linkedField]
    }
    
    cellConfig.value = {
      displayType: cellData.displayType || 'text',
      textContent: cellData.textContent || cellData.fixedValue || '',
      datasetId: cellData.datasetId || '1', // ÈªòËÆ§Êï∞ÊçÆÊ∫ê
      dataStructure: isHiddenCell.value && cellData.dataStructure === 'list' 
        ? 'single' // Ë¢´ÂêàÂπ∂ÁöÑÂçïÂÖÉÊ†ºÂº∫Âà∂‰ΩøÁî®ÂçïÊù°Ê®°Âºè
        : cellData.dataStructure || 'single',
      sheetConfig: cellData.sheetConfig || 'current',
      displayFields: displayFields,
      displayField: displayFields[0] || '', // ÂêëÂêéÂÖºÂÆπ
      // ÂêëÂêéÂÖºÂÆπ
      fillType: cellData.fillType || '',
      fixedValue: cellData.fixedValue || '',
      linkedField: cellData.linkedField || ''
    }
    console.log('ËÆæÁΩÆÁöÑcellConfig:', cellConfig.value)
    console.log('displayFieldsÊï∞ÁªÑ:', cellConfig.value.displayFields)
  } else {
    cellConfig.value = {
      displayType: 'text',
      textContent: '',
      datasetId: '',
      dataStructure: 'single', // ÈªòËÆ§‰∏∫ÂçïÊù°
      sheetConfig: 'current',
      displayFields: [],
      displayField: '', // ÂêëÂêéÂÖºÂÆπ
      fillType: '',
      fixedValue: '',
      linkedField: ''
    }
  }
  
  showCellConfigDialog.value = true
}

// Ë∞ÉËØïÂ∑≤ÁßªÈô§

const confirmCellConfig = () => {
  if (!selectedCellInfo.value) return
  
  const { sectionId, rowIndex, colIndex, isStats } = selectedCellInfo.value
  
  // Ê†πÊçÆÊòØÂê¶‰∏∫ÁªüËÆ°Ë°åÂÜ≥ÂÆöÂ≠òÂÇ®‰ΩçÁΩÆÂíåÊõ¥Êñ∞ÂÖÉÁ¥†
  if (isStats) {
    const cellKey = `stats_${sectionId}_${colIndex}`
    statisticsConfigurations.value[cellKey] = { ...cellConfig.value }
    
    // Êõ¥Êñ∞ÁªüËÆ°Ë°åÂçïÂÖÉÊ†ºÊòæÁ§∫
    const statsElement = document.getElementById(`stats_cell_${sectionId}_${colIndex}`)
    if (statsElement) {
      let displayContent = ''
      if (cellConfig.value.fillType === 'fixed') {
        displayContent = cellConfig.value.fixedValue || 'ÁªüËÆ°ÂÄº'
      } else if (cellConfig.value.fillType === 'auto') {
        displayContent = 'Âä®ÊÄÅÊ±áÊÄª'
      }
      statsElement.textContent = displayContent
      
      // ËÆæÁΩÆÊ†∑Âºè
      if (cellConfig.value.fillType === 'fixed') {
        statsElement.style.backgroundColor = '#e6f7ff'
        statsElement.style.color = '#1890ff'
      } else if (cellConfig.value.fillType === 'auto') {
        statsElement.style.backgroundColor = '#f0f9ff'
        statsElement.style.color = '#52c41a'
      }
    }
  } else {
    const cellKey = `${sectionId}_${rowIndex}_${colIndex}`
    
    // Â≠òÂÇ®ÂçïÂÖÉÊ†ºÈÖçÁΩÆ
    cellConfigurations.value[cellKey] = { ...cellConfig.value }
    
    // Á°Æ‰øùÂ∫ïÂ±ÇÊï∞ÊçÆÁªìÊûÑÂ≠òÂú®Ôºå‰ΩÜ‰∏çÁõ¥Êé•‰øÆÊîπÂÜÖÂÆπ
    // ÂÜÖÂÆπÊòæÁ§∫‰∫§Áªô getCellDisplayContent ÂáΩÊï∞Â§ÑÁêÜ
    const rows = getContentRows(sectionId)
    if (rows && rows[rowIndex]) {
      if (!rows[rowIndex].cells) {
        rows[rowIndex].cells = []
      }
      
      // Á°Æ‰øùÂçïÂÖÉÊ†º‰ΩçÁΩÆÂ≠òÂú®Ôºå‰ΩÜÂÜÖÂÆπÁî± getCellDisplayContent ÊéßÂà∂ÊòæÁ§∫
      if (rows[rowIndex].cells[colIndex] === undefined) {
        rows[rowIndex].cells[colIndex] = ''
      }
    }
  }
  
  console.log('‰øùÂ≠òÂçïÂÖÉÊ†ºÈÖçÁΩÆ:', {
    cellInfo: selectedCellInfo.value,
    config: cellConfig.value,
    isStats
  })
  
  // Â¶ÇÊûúÊòØÊôÆÈÄöÂçïÂÖÉÊ†ºÔºàÈùûÁªüËÆ°Ë°åÔºâ‰∏îÊúâÂÜÖÂÆπÈÖçÁΩÆÔºåÊ£ÄÊü•ÊòØÂê¶ÈúÄË¶ÅËá™Âä®Êâ©Â±ï
  if (!isStats) {
    const cellKey = `${sectionId}_${rowIndex}_${colIndex}`
    const config = cellConfigurations.value[cellKey]
    
    // Ê£ÄÊü•ÊòØÂê¶ÊúâÊúâÊïàÁöÑÈÖçÁΩÆÂÜÖÂÆπ
    let hasContent = false
    if (config) {
      if (config.displayType === 'text' && config.textContent) {
        hasContent = config.textContent.trim() !== ''
      } else if (config.displayType === 'dataset' && config.displayField) {
        hasContent = true
      } else if (config.fillType === 'fixed' && config.fixedValue) {
        hasContent = config.fixedValue.trim() !== ''
      } else if (config.fillType === 'auto' && config.linkedField) {
        hasContent = true
      }
    }
    
    console.log(`üî• Êìç‰ΩúÁ¨¨${rowIndex + 1}Ë°åÁ¨¨${colIndex + 1}Âàó, hasContent=${hasContent}`)
    
    if (hasContent) {
      autoAddColumnIfNeeded(sectionId, colIndex)
      autoAddRowIfNeeded(sectionId, rowIndex)
    }
  }
  
  showCellConfigDialog.value = false
  ElMessage.success('ÂçïÂÖÉÊ†ºÈÖçÁΩÆ‰øùÂ≠òÊàêÂäü')
}

// ÊóßÁöÑhandleCellClickÂáΩÊï∞Â∑≤Ë¢´Âà†Èô§Ôºå‰ΩøÁî®Êñ∞ÁöÑÊ°ÜÈÄâÁâàÊú¨

// ÁªüËÆ°Ë°åÁõ∏ÂÖ≥ÊñπÊ≥ï
const handleStatsCellClick = (sectionId, colIndex) => {
  const cellKey = `stats_${sectionId}_${colIndex}`
  const existingConfig = statisticsConfigurations.value[cellKey]
  openStatsCellConfigDialog(sectionId, colIndex, existingConfig)
}

const openStatsCellConfigDialog = (sectionId, colIndex, cellData) => {
  selectedCellInfo.value = {
    sectionId,
    rowIndex: 'stats',
    colIndex,
    isStats: true
  }
  
  // ÂàùÂßãÂåñÂºπÁ™óÊï∞ÊçÆ
  cellConfig.value = {
    fillType: cellData?.fillType || '',
    fixedValue: cellData?.fixedValue || '',
    linkedField: cellData?.linkedField || ''
  }
  
  showCellConfigDialog.value = true
}

const getStatsContent = (sectionId, colIndex) => {
  const cellKey = `stats_${sectionId}_${colIndex}`
  const config = statisticsConfigurations.value[cellKey]
  
  if (config) {
    if (config.fillType === 'fixed') {
      return config.fixedValue || 'ÁªüËÆ°ÂÄº'
    } else if (config.fillType === 'auto') {
      return 'Âä®ÊÄÅÊ±áÊÄª'
    }
  }
  
  return 'ÁÇπÂáªÈÖçÁΩÆ'
}

// Ëé∑ÂèñÂçïÂÖÉÊ†ºÊòæÁ§∫ÂÜÖÂÆπ
const getCellDisplayContent = (sectionId, rowIndex, colIndex, originalContent) => {
  const cellKey = `${sectionId}_${rowIndex}_${colIndex}`
  const config = cellConfigurations.value[cellKey]
  
  // Â¶ÇÊûúÊúâÈÖçÁΩÆÔºåÊ†πÊçÆÈÖçÁΩÆÊòæÁ§∫ÂÜÖÂÆπ
  if (config) {
    if (config.displayType === 'text') {
      // ‰ªÖÊñáÂ≠óÊ®°Âºè
      return config.textContent || ''
    } else if (config.displayType === 'dataset' && config.displayField) {
      // Êï∞ÊçÆÈõÜÊ®°Âºè
      if (config.dataStructure === 'list') {
        return `[ÂàóË°®Êï∞ÊçÆ: ${config.displayField}]`
      } else {
        // ÂçïÊù°Êï∞ÊçÆ
        return getFieldDisplayValue(config.displayField)
      }
    }
    
    // ÂêëÂêéÂÖºÂÆπÊóßÁöÑÈÖçÁΩÆÊñπÂºè
    if (!config.displayType && config.fillType === 'fixed' && config.fixedValue) {
      return config.fixedValue
    } else if (!config.displayType && config.fillType === 'auto' && config.linkedField) {
      return getFieldDisplayValue(config.linkedField)
    }
  }
  
  // Â¶ÇÊûúÊ≤°ÊúâÈÖçÁΩÆÊàñÈÖçÁΩÆÊó†ÊïàÔºåËøîÂõûÂéüÂßãÂÜÖÂÆπ
  return originalContent || ''
}

// Ëé∑ÂèñÂçïÂÖÉÊ†ºÊ†∑ÂºèÁ±ª
const getCellClass = (sectionId, rowIndex, colIndex) => {
  const cellKey = `${sectionId}_${rowIndex}_${colIndex}`
  const config = cellConfigurations.value[cellKey]
  
  let classes = []
  
  // ÈÖçÁΩÆÁä∂ÊÄÅÊ†∑Âºè
  if (config) {
    if (config.fillType === 'fixed' || config.displayType === 'text') {
      classes.push('cell-configured-fixed')
    } else if (config.fillType === 'auto' || config.displayType === 'dataset') {
      classes.push('cell-configured-auto')
    }
  } else {
    classes.push('cell-not-configured')
  }
  
  // ÊãñÊãΩÈÄâÊã©‰∏≠ÁöÑÈ¢ÑËßàÊïàÊûú
  if (dragStart.value && dragEnd.value && mergeMode.value[sectionId]) {
    const minRow = Math.min(dragStart.value.row, dragEnd.value.row)
    const maxRow = Math.max(dragStart.value.row, dragEnd.value.row)
    const minCol = Math.min(dragStart.value.col, dragEnd.value.col)
    const maxCol = Math.max(dragStart.value.col, dragEnd.value.col)
    
    if (rowIndex >= minRow && rowIndex <= maxRow && colIndex >= minCol && colIndex <= maxCol) {
      classes.push('cell-selecting')
    }
  }
  
  // ÈÄâ‰∏≠Áä∂ÊÄÅÊ†∑Âºè
  const selected = selectedCells.value[sectionId]
  if (selected && selected.some(cell => cell.row === rowIndex && cell.col === colIndex)) {
    classes.push('cell-selected')
  }
  
  // ÂêàÂπ∂Áä∂ÊÄÅÊ†∑Âºè
  const mergeKey = `${rowIndex}_${colIndex}`
  if (mergedCells.value[sectionId] && mergedCells.value[sectionId][mergeKey]) {
    classes.push('cell-merged')
  }
  
  return classes.join(' ')
}

// Ëé∑ÂèñÂ≠óÊÆµÊòæÁ§∫ÂÄº
const getFieldDisplayValue = (fieldKey) => {
  const fieldMap = {
    // Áî®Êà∑ÊùÉÈôêÂ≠óÊÆµ
    'data_batch': '2024-12',
    'org_code': 'ORG001',
    'org_name': 'ÊÄªÂÖ¨Âè∏',
    'parent_org_code': '',
    'person_name': 'Âº†‰∏â',
    'account_type': 'ÁÆ°ÁêÜÂëòË¥¶Êà∑',
    'phone': '13800138000',
    'entry_time': '2024-01-15',
    
    // Á≥ªÁªüÊó•ÂøóÂ≠óÊÆµ
    'log_id': 'LOG001',
    'log_time': '2024-12-10 08:30:00',
    'log_level': 'INFO',
    'module': 'Áî®Êà∑ÁôªÂΩï',
    'message': 'Áî®Êà∑Âº†‰∏âÊàêÂäüÁôªÂΩïÁ≥ªÁªü',
    'ip_address': '192.168.1.100',
    
    // ‰∏öÂä°Êï∞ÊçÆÂ≠óÊÆµ
    'business_id': 'BUS001',
    'customer_name': 'ÈòøÈáåÂ∑¥Â∑¥ÈõÜÂõ¢',
    'contract_amount': '1,500,000.00',
    'contract_date': '2024-01-15',
    'status': 'ÊâßË°å‰∏≠',
    'manager': 'Âº†‰∏â',
    'department': 'ÈîÄÂîÆÈÉ®',
    
    // Ë¥¢Âä°Êï∞ÊçÆÂ≠óÊÆµ
    'account_code': 'ACC001',
    'account_name': 'Èì∂Ë°åÂ≠òÊ¨æ',
    'balance': '5,680,000.00',
    'currency': 'CNY',
    'last_update': '2024-12-09',
    
    // ‰∫∫‰∫ãÊï∞ÊçÆÂ≠óÊÆµ
    'employee_id': 'EMP001',
    'employee_name': 'Âº†‰∏â',
    'position': 'È´òÁ∫ßÂ∑•Á®ãÂ∏à',
    'hire_date': '2020-01-15',
    'salary': '25,000.00'
  }
  return fieldMap[fieldKey] || 'Á§∫‰æãÊï∞ÊçÆ'
}

// Â§ÑÁêÜ‰øùÂ≠òÈÖçÁΩÆ
const handleSaveConfig = async () => {
  try {
    saving.value = true
    
    // ÂáÜÂ§áÂÆåÊï¥ÁöÑÁªìÊûÑÊï∞ÊçÆÔºåÂåÖÊã¨Ë°®Ê†ºÂÜÖÂÆπ
    const structureWithContent = JSON.parse(JSON.stringify(template.value.structure))
    
    console.log('Âç≥Â∞Ü‰øùÂ≠òÁöÑÂÆåÊï¥ÁªìÊûÑ:', JSON.stringify(structureWithContent, null, 2))
    
    // Â∞ÜË°®Ê†ºÂÜÖÂÆπÊï∞ÊçÆÂêàÂπ∂Âà∞ÁªìÊûÑ‰∏≠
    if (structureWithContent.sections) {
      structureWithContent.sections.forEach(section => {
        if (section.hasTable) {
          const rows = getContentRows(section.id)
          console.log(`‰øùÂ≠òË°®Ê†º ${section.id}:`)
          console.log(`  ÂΩìÂâçË°®Â§¥Êï∞Èáè: ${section.tableStructure?.headers?.length || 0}`)
          console.log(`  ÂΩìÂâçË°åÊï∞: ${rows ? rows.length : 0}`)
          console.log(`  Ë°®Ê†ºÁªìÊûÑ: rowCount=${section.tableStructure?.rowCount}, columnCount=${section.tableStructure?.columnCount}`)
          
          if (rows && rows.length > 0) {
            // Â∞ÜÂÆûÈôÖÁöÑË°®Ê†ºÊï∞ÊçÆ‰øùÂ≠òÂà∞ÁªìÊûÑ‰∏≠
            section.tableData = rows.map(row => ({
              name: row.name || '',
              type: row.type || 'data',
              cells: row.cells || [],
              locked: row.locked || false
            }))
            
            console.log(`  ‰øùÂ≠òÁöÑtableData: ${section.tableData.length}Ë°å`)
            section.tableData.forEach((row, index) => {
              console.log(`    Ë°å${index}: name="${row.name}", cellsÊï∞Èáè=${row.cells.length}`)
            })
          }
        }
      })
    }
    
    // Áªü‰∏Ä‰øùÂ≠òÊâÄÊúâÈÖçÁΩÆÊï∞ÊçÆÂíåÂÆåÊï¥ÁªìÊûÑ
    await saveConfig(templateId.value, {
      tableNames: tableNames.value,
      tableDataSources: tableDataSources.value,
      tableRemarks: tableRemarks.value,
      statisticsEnabled: statisticsEnabled.value,
      cellConfigurations: cellConfigurations.value,
      statisticsConfigurations: statisticsConfigurations.value,
      mergedCells: mergedCells.value, // Ê∑ªÂä†ÂêàÂπ∂ÂçïÂÖÉÊ†º‰ø°ÊÅØ
      templateStructure: structureWithContent // ‰º†ÈÄíÂåÖÂê´Ë°®Ê†ºÊï∞ÊçÆÁöÑÂÆåÊï¥ÁªìÊûÑ
    })
    
    ElMessage.success('ÈÖçÁΩÆ‰øùÂ≠òÊàêÂäüÔºÅ')
  } catch (error) {
    console.error('‰øùÂ≠òÂ§±Ë¥•:', error)
    ElMessage.error('‰øùÂ≠òÂ§±Ë¥•: ' + error.message)
  } finally {
    saving.value = false
  }
}



const handleGridCellClick = (event) => {
  console.log('Grid cell clicked:', event)
  // ËøôÈáåÂèØ‰ª•Ê∑ªÂä†ÂçïÂÖÉÊ†ºÁÇπÂáªÁöÑÂ§ÑÁêÜÈÄªËæë
}


// HTMLË°®Ê†ºÁºñËæëÂäüËÉΩ
const editingCell = ref('')
const editingValue = ref('')

const handleTableCellClick = (sectionId, rowIndex, colIndex) => {
  console.log('Table cell clicked:', sectionId, rowIndex, colIndex)
  // ÂçïÂáª‰∏çÂÜçÊâìÂºÄÂºπÁ™óÔºåÂè™Áî®‰∫éË∞ÉËØïÊó•Âøó
}

const editCell = (sectionId, rowIndex, colIndex) => {
  const rows = getContentRows(sectionId)
  editingCell.value = `${sectionId}_${rowIndex}_${colIndex}`
  
  editingValue.value = rows[rowIndex].cells?.[colIndex] || ''
  
  // ËÅöÁÑ¶Âà∞ËæìÂÖ•Ê°Ü
  nextTick(() => {
    const input = document.querySelector('.cell-input')
    if (input) {
      input.focus()
      input.select()
    }
  })
}

const confirmEdit = (sectionId, rowIndex, colIndex) => {
  const rows = getContentRows(sectionId)
  
  if (!rows[rowIndex].cells) {
    rows[rowIndex].cells = []
  }
  
  // ‰øùÂ≠òÊñ∞ÂÜÖÂÆπ
  rows[rowIndex].cells[colIndex] = editingValue.value
  
  editingCell.value = ''
  editingValue.value = ''
}

const cancelEdit = () => {
  editingCell.value = ''
  editingValue.value = ''
}

// ÂàáÊç¢ÂêàÂπ∂Ê®°Âºè
const toggleMergeMode = (sectionId) => {
  if (mergeMode.value[sectionId]) {
    mergeMode.value[sectionId] = false
    selectedCells.value[sectionId] = []
  } else {
    mergeMode.value[sectionId] = true
  }
}

// Èº†Ê†áÊåâ‰∏ã‰∫ã‰ª∂ - ÂºÄÂßãÊ°ÜÈÄâ
const handleCellMouseDown = (sectionId, rowIndex, colIndex, event) => {
  if (mergeMode.value[sectionId]) {
    event.preventDefault()
    dragStart.value = { sectionId, row: rowIndex, col: colIndex }
    dragEnd.value = { sectionId, row: rowIndex, col: colIndex }
    updateSelectedCells(sectionId)
  }
}

// Èº†Ê†áËøõÂÖ•‰∫ã‰ª∂ - Êõ¥Êñ∞Ê°ÜÈÄâËåÉÂõ¥
const handleCellMouseEnter = (sectionId, rowIndex, colIndex, event) => {
  if (mergeMode.value[sectionId] && dragStart.value && event.buttons === 1) {
    dragEnd.value = { sectionId, row: rowIndex, col: colIndex }
    updateSelectedCells(sectionId)
  }
}

// Èº†Ê†áÈáäÊîæ‰∫ã‰ª∂ - ÂÆåÊàêÊ°ÜÈÄâ
const handleCellMouseUp = (sectionId, rowIndex, colIndex, event) => {
  if (mergeMode.value[sectionId] && dragStart.value) {
    dragEnd.value = { sectionId, row: rowIndex, col: colIndex }
    updateSelectedCells(sectionId)
    // Ëá™Âä®ÊâßË°åÂêàÂπ∂
    if (selectedCells.value[sectionId] && selectedCells.value[sectionId].length > 1) {
      performMerge(sectionId)
    }
    // ÈáçÁΩÆÊãñÊãΩÁä∂ÊÄÅ
    dragStart.value = null
    dragEnd.value = null
  }
}

// Êõ¥Êñ∞ÈÄâ‰∏≠ÁöÑÂçïÂÖÉÊ†º
const updateSelectedCells = (sectionId) => {
  if (!dragStart.value || !dragEnd.value) return
  
  const minRow = Math.min(dragStart.value.row, dragEnd.value.row)
  const maxRow = Math.max(dragStart.value.row, dragEnd.value.row)
  const minCol = Math.min(dragStart.value.col, dragEnd.value.col)
  const maxCol = Math.max(dragStart.value.col, dragEnd.value.col)
  
  selectedCells.value[sectionId] = []
  for (let r = minRow; r <= maxRow; r++) {
    for (let c = minCol; c <= maxCol; c++) {
      selectedCells.value[sectionId].push({
        key: `${r}_${c}`,
        row: r,
        col: c
      })
    }
  }
}

// Ëá™Âä®Ê∑ªÂä†Êñ∞Âàó - ÂΩìÊìç‰ΩúÂà∞ÊúÄÂêé‰∏ÄÂàóÊó∂Ëá™Âä®Êâ©Â±ï
const autoAddColumnIfNeeded = (sectionId, colIndex) => {
  if (!template.value?.structure?.sections) return
  
  const section = template.value.structure.sections.find(s => s.id === sectionId)
  if (!section?.tableStructure) return
  
  // ÈáçÊñ∞Ëé∑ÂèñÂΩìÂâçÂÆûÈôÖÁöÑË°åÊï∞ÊçÆÔºàÂõ†‰∏∫ÂºπÁ™óÂõûÂ°´Êó∂ÂèØËÉΩÂ∑≤ÁªèÂä®ÊÄÅ‰øÆÊîπËøáÔºâ
  const rows = getContentRows(sectionId)
  if (!rows || rows.length === 0) return
  
  // ÈáçÊñ∞ËÆ°ÁÆóÂÆûÈôÖÁöÑÊúÄÂ§ßÂàóÊï∞ÔºàÂü∫‰∫éÂÆûÈôÖÊï∞ÊçÆÔºâ
  let actualMaxColumns = 0
  rows.forEach(row => {
    const cellCount = row.cells ? row.cells.length : 0
    if (cellCount > actualMaxColumns) {
      actualMaxColumns = cellCount
    }
  })
  
  // ÈáçÊñ∞Ëé∑ÂèñË°®Â§¥ÁöÑÂàóÊï∞ÂíåÈÖçÁΩÆÁöÑÂàóÊï∞
  const headerCount = section.tableStructure.headers?.length || 0
  const configuredColumnCount = section.tableStructure.columnCount || 0
  const maxColumnCount = Math.max(actualMaxColumns, headerCount, configuredColumnCount)
  
  // Â¶ÇÊûúÊìç‰ΩúÁöÑÊòØÊúÄÂêé‰∏ÄÂàóÔºåËá™Âä®Ê∑ªÂä†Êñ∞Âàó
  console.log(`Ê£ÄÊü•Ëá™Âä®Ê∑ªÂä†Âàó: colIndex=${colIndex}, headerCount=${headerCount}, ÊòØÂê¶‰∏∫ÊúÄÂêé‰∏ÄÂàó: ${colIndex === headerCount - 1}`)
  if (colIndex === headerCount - 1) {
    const newColumnCount = headerCount + 1
    
    // Êõ¥Êñ∞Ë°®Â§¥
    if (!section.tableStructure.headers) {
      section.tableStructure.headers = []
    }
    
    // Á°Æ‰øùË°®Â§¥Êï∞ÁªÑÊúâË∂≥Â§üÁöÑÈïøÂ∫¶
    while (section.tableStructure.headers.length < newColumnCount) {
      const newHeaderIndex = section.tableStructure.headers.length
      const newHeaderName = `Âàó${newHeaderIndex + 1}`
      
      // ÂàõÂª∫ÂÆåÊï¥ÁöÑheaderÂØπË±°ÁªìÊûÑÔºå‰øùÊåÅ‰∏éÂéüÂßãheaderÂØπË±°‰∏ÄËá¥
      section.tableStructure.headers.push({
        index: newHeaderIndex,
        name: newHeaderName,
        originalName: newHeaderName,
        parentHeader: null,
        dataType: "FIXED",
        value: "",
        sqlQuery: "",
        dataSourceId: null
      })
    }
    
    section.tableStructure.columnCount = newColumnCount
    
    // ‰∏∫ÊâÄÊúâË°åÊ∑ªÂä†Êñ∞ÂàóÁöÑÁ©∫ÂçïÂÖÉÊ†º
    rows.forEach(row => {
      if (!row.cells) row.cells = []
      // Á°Æ‰øùÊØèË°åÊúâË∂≥Â§üÁöÑÂçïÂÖÉÊ†º
      while (row.cells.length < newColumnCount) {
        row.cells.push('')
      }
    })
    
    console.log(`Ëá™Âä®Ê∑ªÂä†Êñ∞ÂàóÔºö${section.name} Áé∞Âú®Êúâ ${newColumnCount} Âàó`)
  }
}

// Ëá™Âä®Ê∑ªÂä†Êñ∞Ë°å - ÂΩìÊìç‰ΩúÂà∞ÊúÄÂêé‰∏ÄË°åÊó∂Ëá™Âä®Êâ©Â±ï
const autoAddRowIfNeeded = (sectionId, rowIndex) => {
  if (!template.value?.structure?.sections) return
  
  const section = template.value.structure.sections.find(s => s.id === sectionId)
  if (!section?.tableStructure) return
  
  // ÈáçÊñ∞Ëé∑ÂèñÂΩìÂâçÂÖ®Â±ÄË°®Ê†ºË°åÊï∞ÔºàÂåÖÂê´Ë°®Â§¥ÂíåÊï∞ÊçÆË°åÔºâ
  const allRows = getAllTableRows(sectionId)
  if (!allRows || allRows.length === 0) return
  
  const totalRowCount = allRows.length
  
  console.log(`üîç Ë°åÊâ©Â±ïÊ£ÄÊü•: Á¨¨${rowIndex + 1}Ë°å(Á¥¢Âºï${rowIndex}) ÂÖ®Â±ÄÂÖ±${totalRowCount}Ë°å ÊòØÂê¶ÊúÄÂêé‰∏ÄË°å:${rowIndex === totalRowCount - 1}`)
  
  if (rowIndex === totalRowCount - 1) {
    // Ëé∑ÂèñÊï∞ÊçÆË°åÊù•Ê∑ªÂä†Êñ∞Ë°å
    const dataRows = getContentRows(sectionId)
    
    // Ëé∑ÂèñÂΩìÂâçÊúÄÂ§ßÂàóÊï∞
    let maxColumns = section.tableStructure.columnCount || 0
    const headerCount = section.tableStructure.headers?.length || 0
    maxColumns = Math.max(maxColumns, headerCount)
    
    // ËÆ°ÁÆóÂÆûÈôÖÈúÄË¶ÅÁöÑÂàóÊï∞
    dataRows.forEach(row => {
      const cellCount = row.cells ? row.cells.length : 0
      if (cellCount > maxColumns) {
        maxColumns = cellCount
      }
    })
    
    // ÂàõÂª∫Êñ∞Ë°åÔºåÂåÖÂê´ÊâÄÊúâÂàóÁöÑÁ©∫ÂçïÂÖÉÊ†º
    const newRow = {
      name: `Ë°å${dataRows.length + 1}`,
      type: 'data',
      cells: new Array(maxColumns).fill(''),
      locked: false
    }
    
    // Ê∑ªÂä†Êñ∞Ë°åÂà∞Êï∞ÊçÆ‰∏≠
    dataRows.push(newRow)
    
    // Êõ¥Êñ∞Ë°®Ê†ºË°åÊï∞
    section.tableStructure.rowCount = dataRows.length
    
    console.log(`Ëá™Âä®Ê∑ªÂä†Êñ∞Ë°åÔºö${section.name} Áé∞Âú®Êúâ ${dataRows.length} Ë°åÊï∞ÊçÆ`)
  }
}

// ÂçïÂáª‰∫ã‰ª∂ - ÈÄâÊã©Âçï‰∏™ÂçïÂÖÉÊ†ºÊàñÈÄÄÂá∫ÂêàÂπ∂Ê®°Âºè
const handleCellClickEvent = (sectionId, rowIndex, colIndex, event) => {
  if (!mergeMode.value[sectionId]) {
    // ÈùûÂêàÂπ∂Ê®°ÂºèÔºöÈÄâÊã©Âçï‰∏™ÂçïÂÖÉÊ†º
    selectedCells.value[sectionId] = [{
      key: `${rowIndex}_${colIndex}`,
      row: rowIndex,
      col: colIndex
    }]
  }
}

// Â§ÑÁêÜÂèåÂáª‰∫ã‰ª∂
const handleCellDoubleClick = (sectionId, rowIndex, colIndex, event) => {
  event.preventDefault()
  
  if (!mergeMode.value[sectionId]) {
    // ÂèåÂáªÊó∂ÊâìÂºÄÈÖçÁΩÆÂºπÁ™ó
    const cellKey = `${sectionId}_${rowIndex}_${colIndex}`
    const existingConfig = cellConfigurations.value[cellKey]
    console.log('ÊâìÂºÄÂçïÂÖÉÊ†ºÈÖçÁΩÆ:', { cellKey, existingConfig })
    openCellConfigDialog(sectionId, rowIndex, colIndex, existingConfig)
  }
}

// ÂºÄÂßãÁºñËæëÂçïÂÖÉÊ†º
const startCellEdit = (sectionId, rowIndex, colIndex) => {
  const cellKey = `${sectionId}_${rowIndex}_${colIndex}`
  editingCell.value = cellKey
  
  // Ëé∑ÂèñÂΩìÂâçÂçïÂÖÉÊ†ºÁöÑÂÜÖÂÆπ
  const rows = getContentRows(sectionId)
  const currentValue = rows[rowIndex]?.cells?.[colIndex] || ''
  editingValue.value = currentValue
  
  // Âª∂ËøüËÅöÁÑ¶Âà∞ËæìÂÖ•Ê°Ü
  nextTick(() => {
    const input = document.querySelector(`input[v-model="editingValue"]`)
    if (input) {
      input.focus()
      input.select()
    }
  })
}


// Ê£ÄÊü•ÂçïÂÖÉÊ†ºÊòØÂê¶ÊòØÂêàÂπ∂ÂçïÂÖÉÊ†ºÁöÑ‰∏ªÂçïÂÖÉÊ†º
const isCellMerged = (sectionId, rowIndex, colIndex) => {
  if (!mergedCells.value[sectionId]) return false
  
  const cellKey = `${rowIndex}_${colIndex}`
  return !!mergedCells.value[sectionId][cellKey]
}

// Ê£ÄÊü•ÂçïÂÖÉÊ†ºÊòØÂê¶Ë¢´ÈöêËóèÔºàË¢´ÂêàÂπ∂ÁöÑÂçïÂÖÉÊ†ºÔºâ
const isCellHidden = (sectionId, rowIndex, colIndex) => {
  if (!mergedCells.value[sectionId]) return false
  
  for (const mergeKey in mergedCells.value[sectionId]) {
    const merge = mergedCells.value[sectionId][mergeKey]
    if (rowIndex >= merge.startRow && rowIndex < merge.startRow + merge.rowspan &&
        colIndex >= merge.startCol && colIndex < merge.startCol + merge.colspan &&
        !(rowIndex === merge.startRow && colIndex === merge.startCol)) {
      return true
    }
  }
  return false
}

// Ëé∑ÂèñÂçïÂÖÉÊ†ºÁöÑcolspan
const getCellColspan = (sectionId, rowIndex, colIndex) => {
  if (!mergedCells.value[sectionId]) {
    return 1
  }
  
  const cellKey = `${rowIndex}_${colIndex}`
  const merge = mergedCells.value[sectionId][cellKey]
  
  return merge ? merge.colspan : 1
}

// Ëé∑ÂèñÂçïÂÖÉÊ†ºÁöÑrowspan
const getCellRowspan = (sectionId, rowIndex, colIndex) => {
  if (!mergedCells.value[sectionId]) {
    return 1
  }
  
  const cellKey = `${rowIndex}_${colIndex}`
  const merge = mergedCells.value[sectionId][cellKey]
  
  return merge ? merge.rowspan : 1
}

// ÊâßË°åÂêàÂπ∂Êìç‰Ωú
// Êõ¥Êñ∞Ë°®Â§¥ÂêçÁß∞
const updateHeaderName = (sectionId, index, newName) => {
  const section = template.value.structure.sections.find(s => s.id === sectionId)
  if (section && section.tableStructure && section.tableStructure.headers[index]) {
    section.tableStructure.headers[index].name = newName
  }
}

// Êõ¥Êñ∞ÂêàÂπ∂Ë°®Â§¥ÁöÑÂêçÁß∞
const updateMergedHeaderName = (sectionId, group, newName) => {
  const section = template.value.structure.sections.find(s => s.id === sectionId)
  if (!section || !section.tableStructure) return
  
  // Â¶ÇÊûúÊòØÁã¨Á´ãÂàóÔºåÁõ¥Êé•Êõ¥Êñ∞
  if (group.type === 'independent') {
    const header = section.tableStructure.headers.find(h => h.name === group.name)
    if (header) {
      header.name = newName
    }
  } else {
    // Â¶ÇÊûúÊòØÁà∂Ë°®Â§¥ÔºåÊõ¥Êñ∞ÊâÄÊúâÂ≠êË°®Â§¥ÁöÑparentHeader
    section.tableStructure.headers.forEach(header => {
      if (header.parentHeader === group.name) {
        header.parentHeader = newName
      }
    })
  }
}

// === Êó†Ë°®Â§¥Á∫ØÊï∞ÊçÆË°®Ê†ºÊîØÊåÅ ===

// Ëé∑ÂèñÊâÄÊúâË°®Ê†ºË°åÊï∞ÊçÆÔºàË°®Â§¥‰Ωú‰∏∫Êï∞ÊçÆË°å + ÂéüÂÜÖÂÆπË°åÔºâ
const getAllTableRows = (sectionId) => {
  const section = template.value.structure.sections.find(s => s.id === sectionId)
  if (!section?.tableStructure?.headers) return []
  
  const allRows = []
  
  // 1. Ê∑ªÂä†Ë°®Â§¥‰Ωú‰∏∫ÊôÆÈÄöÊï∞ÊçÆË°åÔºàÁÆÄÂåñÂ§ÑÁêÜÔºâ
  if (hasMergedHeaders(section.tableStructure.headers)) {
    // ÊúâÂêàÂπ∂Ë°®Â§¥ÔºöÁîüÊàê‰∏§Ë°å
    const groups = getMergedHeaderGroups(section.tableStructure.headers)
    
    // Á¨¨‰∏ÄË°åÔºöÁà∂Ë°®Â§¥
    const firstRow = []
    groups.forEach(group => {
      firstRow.push(group.name || '')
      // ÂêàÂπ∂ÂàóÁöÑÂÖ∂‰ªñ‰ΩçÁΩÆÂ°´Á©∫
      for (let i = 1; i < group.colspan; i++) {
        firstRow.push('')
      }
    })
    allRows.push(firstRow)
    
    // Á¨¨‰∫åË°åÔºöÂ≠êË°®Â§¥
    const secondRow = section.tableStructure.headers.map(header => {
      if (!header.parentHeader || header.parentHeader.trim() === '') {
        return '' // Áã¨Á´ãÂàóÂú®Á¨¨‰∫åË°å‰∏∫Á©∫
      }
      return header.name || ''
    })
    allRows.push(secondRow)
  } else {
    // ÁÆÄÂçïË°®Â§¥ÔºöÁîüÊàê‰∏ÄË°å
    const headerRow = section.tableStructure.headers.map(header => header.name || '')
    allRows.push(headerRow)
  }
  
  // 2. Ê∑ªÂä†ÂéüÊúâÁöÑÂÜÖÂÆπÊï∞ÊçÆË°åÔºà‰øùÊåÅÂéüÈÄªËæë‰∏çÂèòÔºâ
  const contentRows = getContentRows(sectionId)
  contentRows.forEach(row => {
    const rowData = section.tableStructure.headers.map((header, index) => {
      if (header.name === 'ÂÆ°ËÆ°Âçï‰Ωç') {
        return row.name || ''
      }
      return row.cells?.[index] || ''
    })
    allRows.push(rowData)
  })
  
  return allRows
}


// Ëé∑ÂèñË°®Â§¥Êï∞ÊçÆË°åÁöÑÊï∞Èáè
const getHeaderRowCount = (sectionId) => {
  const section = template.value.structure.sections.find(s => s.id === sectionId)
  if (!section?.tableStructure?.headers) return 0
  
  // Â¶ÇÊûúÊúâÂêàÂπ∂Ë°®Â§¥ÔºåËøîÂõû2Ë°åÔºåÂê¶ÂàôËøîÂõû1Ë°å
  return hasMergedHeaders(section.tableStructure.headers) ? 2 : 1
}

// ÂàùÂßãÂåñË°®Â§¥Ë°åÁöÑÂêàÂπ∂ÂçïÂÖÉÊ†º‰ø°ÊÅØ
const initializeHeaderMergedCells = (sectionId) => {
  const section = template.value.structure.sections.find(s => s.id === sectionId)
  if (!section?.tableStructure?.headers) {
    console.log(`No headers found for section ${sectionId}`)
    return
  }
  
  if (!mergedCells.value[sectionId]) {
    mergedCells.value[sectionId] = {}
  }
  
  console.log(`üîß INITIALIZING HEADER MERGED CELLS FOR SECTION ${sectionId}`)
  console.log('üìã Headers:', section.tableStructure.headers)
  
  // Âè™Â§ÑÁêÜÊúâÂêàÂπ∂Ë°®Â§¥ÁöÑÊÉÖÂÜµ
  if (hasMergedHeaders(section.tableStructure.headers)) {
    const groups = getMergedHeaderGroups(section.tableStructure.headers)
    console.log('Header groups:', groups)
    
    let currentCol = 0
    
    groups.forEach(group => {
      if (group.type === 'independent') {
        // Áã¨Á´ãÂàóÔºöË∑®‰∏§Ë°å
        const mergeKey = `0_${currentCol}`
        mergedCells.value[sectionId][mergeKey] = {
          startRow: 0,
          startCol: currentCol,
          rowspan: 2,
          colspan: 1
        }
        console.log(`Created independent merge at ${mergeKey}:`, mergedCells.value[sectionId][mergeKey])
        currentCol++
      } else {
        // ÂêàÂπ∂ÂàóÁöÑÁà∂Ë°®Â§¥ÔºöË∑®Â§öÂàó
        const mergeKey = `0_${currentCol}`
        mergedCells.value[sectionId][mergeKey] = {
          startRow: 0,
          startCol: currentCol,
          rowspan: 1,
          colspan: group.colspan
        }
        console.log(`Created parent merge at ${mergeKey}:`, mergedCells.value[sectionId][mergeKey])
        currentCol += group.colspan
      }
    })
    
    console.log(`Final merged cells for ${sectionId}:`, mergedCells.value[sectionId])
  } else {
    console.log(`Section ${sectionId} has no merged headers`)
  }
}


const performMerge = (sectionId) => {
  const selected = selectedCells.value[sectionId]
  if (!selected || selected.length < 2) {
    return
  }
  
  // ËÆ°ÁÆóÂêàÂπ∂ËåÉÂõ¥
  const minRow = Math.min(...selected.map(cell => cell.row))
  const maxRow = Math.max(...selected.map(cell => cell.row))
  const minCol = Math.min(...selected.map(cell => cell.col))
  const maxCol = Math.max(...selected.map(cell => cell.col))
  
  const rowspan = maxRow - minRow + 1
  const colspan = maxCol - minCol + 1
  
  if (!mergedCells.value[sectionId]) {
    mergedCells.value[sectionId] = {}
  }
  
  const mergeKey = `${minRow}_${minCol}`
  mergedCells.value[sectionId][mergeKey] = {
    startRow: minRow,
    startCol: minCol,
    rowspan,
    colspan
  }
  
  // Ê∏ÖÈô§ÈÄâÊã©Âπ∂ÈÄÄÂá∫ÂêàÂπ∂Ê®°Âºè
  selectedCells.value[sectionId] = []
  mergeMode.value[sectionId] = false
  
  ElMessage.success('ÂçïÂÖÉÊ†ºÂêàÂπ∂ÊàêÂäü')
}

// ÊãÜÂàÜÈÄâ‰∏≠ÁöÑÂçïÂÖÉÊ†º
const splitSelectedCell = (sectionId) => {
  const selected = selectedCells.value[sectionId]
  if (!selected || selected.length !== 1) {
    ElMessage.warning('ËØ∑ÈÄâÊã©‰∏Ä‰∏™Â∑≤ÂêàÂπ∂ÁöÑÂçïÂÖÉÊ†ºËøõË°åÊãÜÂàÜ')
    return
  }
  
  const cell = selected[0]
  const mergeKey = `${cell.row}_${cell.col}`
  
  if (!mergedCells.value[sectionId] || !mergedCells.value[sectionId][mergeKey]) {
    ElMessage.warning('ËØ•ÂçïÂÖÉÊ†ºÊú™Ë¢´ÂêàÂπ∂')
    return
  }
  
  delete mergedCells.value[sectionId][mergeKey]
  selectedCells.value[sectionId] = []
  
  ElMessage.success('ÂçïÂÖÉÊ†ºÊãÜÂàÜÊàêÂäü')
}

// Ê£ÄÊü•ÊòØÂê¶ÊúâÈÄâ‰∏≠ÁöÑÂêàÂπ∂ÂçïÂÖÉÊ†º
const hasSelectedMergedCell = (sectionId) => {
  const selected = selectedCells.value[sectionId]
  if (!selected || selected.length !== 1 || !mergedCells.value[sectionId]) return false
  
  const cell = selected[0]
  const mergeKey = `${cell.row}_${cell.col}`
  return !!mergedCells.value[sectionId][mergeKey]
}

// Ëé∑ÂèñÂ≠óÊÆµÊ†áÁ≠æ
const getFieldLabel = (field) => {
  const fieldLabels = {
    // Áî®Êà∑ÊùÉÈôêÂ≠óÊÆµ
    data_batch: 'Êï∞ÊçÆÊâπÊ¨°',
    org_code: 'ÁªÑÁªáÁºñÂè∑',
    org_name: 'ÁªÑÁªáÂêçÁß∞',
    parent_org_code: 'Áà∂Á∫ßÊú∫ÊûÑÁºñÂè∑',
    person_name: 'ÂßìÂêç',
    account_type: '‰∏ªË¥¶Âè∑Á±ªÂûã',
    phone: 'ÁîµËØù',
    entry_time: 'ÂΩïÂÖ•Êó∂Èó¥',
    // Á≥ªÁªüÊó•ÂøóÂ≠óÊÆµ
    log_id: 'Êó•ÂøóID',
    log_time: 'Êó•ÂøóÊó∂Èó¥',
    log_level: 'Êó•ÂøóÁ∫ßÂà´',
    module: 'Ê®°ÂùóÂêçÁß∞',
    message: 'Êó•ÂøóÊ∂àÊÅØ',
    ip_address: 'IPÂú∞ÂùÄ',
    user_agent: 'Áî®Êà∑‰ª£ÁêÜ',
    // ‰∏öÂä°Êï∞ÊçÆÂ≠óÊÆµ
    business_id: '‰∏öÂä°ID',
    customer_name: 'ÂÆ¢Êà∑ÂêçÁß∞',
    contract_amount: 'ÂêàÂêåÈáëÈ¢ù',
    contract_date: 'ÂêàÂêåÊó•Êúü',
    status: 'Áä∂ÊÄÅ',
    manager: 'Ë¥üË¥£‰∫∫',
    department: 'ÈÉ®Èó®',
    // Ë¥¢Âä°Êï∞ÊçÆÂ≠óÊÆµ
    account_code: 'Ë¥¶Êà∑‰ª£Á†Å',
    account_name: 'Ë¥¶Êà∑ÂêçÁß∞',
    balance: '‰ΩôÈ¢ù',
    currency: 'Ë¥ßÂ∏ÅÁ±ªÂûã',
    last_update: 'Êõ¥Êñ∞Êó∂Èó¥',
    account_type: 'Ë¥¶Êà∑Á±ªÂûã',
    // ‰∫∫‰∫ãÊï∞ÊçÆÂ≠óÊÆµ
    employee_id: 'ÂëòÂ∑•ID',
    employee_name: 'ÂëòÂ∑•ÂßìÂêç',
    hire_date: 'ÂÖ•ËÅåÊó•Êúü',
    position: 'ËÅå‰Ωç',
    salary: 'Ëñ™ËµÑ'
  }
  return fieldLabels[field] || field
}

// Ëé∑ÂèñÂçïÊù°Â≠óÊÆµÂÄº
const getSingleFieldValue = (field) => {
  const mockData = getPreviewData()
  if (mockData && mockData.length > 0) {
    return mockData[0][field] || 'Êó†Êï∞ÊçÆ'
  }
  return 'Êó†Êï∞ÊçÆ'
}

// Ëé∑ÂèñÈ¢ÑËßàÊï∞ÊçÆ
const getPreviewData = () => {
  // ËøîÂõûmockÊï∞ÊçÆÁöÑÂâç3Êù°Áî®‰∫éÈ¢ÑËßà
  const mockData = [
    {
      data_batch: '2024-12',
      org_code: 'ORG001',
      org_name: 'ÊÄªÂÖ¨Âè∏',
      parent_org_code: '',
      person_name: 'Âº†‰∏â',
      account_type: 'ÁÆ°ÁêÜÂëòË¥¶Êà∑',
      phone: '13800138000',
      entry_time: '2024-01-15',
      log_id: 'LOG001',
      log_time: '2024-12-10 08:30:00',
      log_level: 'INFO',
      module: 'Áî®Êà∑ÁôªÂΩï',
      message: 'Áî®Êà∑Âº†‰∏âÊàêÂäüÁôªÂΩïÁ≥ªÁªü',
      ip_address: '192.168.1.100',
      user_agent: 'Mozilla/5.0...',
      originalLog: '{"createtime":"2025-09-09 16:52:37","dataid":"ark-gateway-prod.yml","elapseTime":123,"level":"INFO","message":"Áî®Êà∑ÁôªÂΩïÊàêÂäü"}',
      business_id: 'BUS001',
      customer_name: 'ÈòøÈáåÂ∑¥Â∑¥ÈõÜÂõ¢',
      contract_amount: 1500000.00,
      contract_date: '2024-01-15',
      status: 'ÊâßË°å‰∏≠',
      manager: 'Âº†‰∏â',
      department: 'ÈîÄÂîÆÈÉ®',
      account_code: 'ACC001',
      account_name: 'Èì∂Ë°åÂ≠òÊ¨æ',
      balance: 5680000.00,
      currency: 'CNY',
      last_update: '2024-12-09',
      employee_id: 'EMP001',
      employee_name: 'Âº†‰∏â',
      hire_date: '2020-01-15',
      position: 'È´òÁ∫ßÂ∑•Á®ãÂ∏à',
      salary: 25000.00
    },
    {
      data_batch: '2024-12',
      org_code: 'ORG002',
      org_name: 'ÂàÜÂÖ¨Âè∏A',
      parent_org_code: 'ORG001',
      person_name: 'ÊùéÂõõ',
      account_type: 'ÊôÆÈÄöÁî®Êà∑',
      phone: '13900139000',
      entry_time: '2024-03-10',
      log_id: 'LOG002',
      log_time: '2024-12-10 09:15:00',
      log_level: 'WARN',
      module: 'ÊùÉÈôêÈ™åËØÅ',
      message: 'Áî®Êà∑ÊùéÂõõÂ∞ùËØïËÆøÈóÆÊó†ÊùÉÈôêÈ°µÈù¢',
      ip_address: '192.168.1.101',
      user_agent: 'Chrome/118.0...',
      originalLog: '{"createtime":"2025-09-09 16:50:56","dataid":"ark-gateway-prod.yml","elapseTime":256,"level":"WARN","message":"ÊùÉÈôêÈ™åËØÅÂ§±Ë¥•"}',
      business_id: 'BUS002',
      customer_name: 'ËÖæËÆØÁßëÊäÄ',
      contract_amount: 2800000.00,
      contract_date: '2024-03-20',
      status: 'Â∑≤ÂÆåÊàê',
      manager: 'ÊùéÂõõ',
      department: 'ÂïÜÂä°ÈÉ®',
      account_code: 'ACC002',
      account_name: 'Â∫îÊî∂Ë¥¶Ê¨æ',
      balance: 2340000.00,
      currency: 'CNY',
      last_update: '2024-12-09',
      employee_id: 'EMP002',
      employee_name: 'ÊùéÂõõ',
      hire_date: '2019-06-01',
      position: 'ÈîÄÂîÆÁªèÁêÜ',
      salary: 22000.00
    },
    {
      data_batch: '2024-12',
      org_code: 'ORG003',
      org_name: 'ÈÉ®Èó®B',
      parent_org_code: 'ORG002',
      person_name: 'Áéã‰∫î',
      account_type: 'ÈÉ®Èó®‰∏ªÁÆ°',
      phone: '13700137000',
      entry_time: '2024-02-20',
      log_id: 'LOG003',
      log_time: '2024-12-10 10:45:00',
      log_level: 'ERROR',
      module: 'Êï∞ÊçÆÂ∫ìËøûÊé•',
      message: 'Êï∞ÊçÆÂ∫ìËøûÊé•Ë∂ÖÊó∂',
      ip_address: '192.168.1.10',
      user_agent: 'System',
      originalLog: '{"createtime":"2025-09-09 16:50:56","dataid":"ark-gateway-prod.yml","elapseTime":5000,"level":"ERROR","message":"Êï∞ÊçÆÂ∫ìËøûÊé•Ë∂ÖÊó∂ÂºÇÂ∏∏"}',
      business_id: 'BUS003',
      customer_name: 'Â≠óËäÇË∑≥Âä®',
      contract_amount: 3200000.00,
      contract_date: '2024-05-10',
      status: 'ÊâßË°å‰∏≠',
      manager: 'Áéã‰∫î',
      department: 'ÊäÄÊúØÈÉ®',
      account_code: 'ACC003',
      account_name: 'Áé∞Èáë',
      balance: 890000.00,
      currency: 'CNY',
      last_update: '2024-12-09',
      employee_id: 'EMP003',
      employee_name: 'Áéã‰∫î',
      hire_date: '2021-03-15',
      position: 'È°πÁõÆÁªèÁêÜ',
      salary: 28000.00
    }
  ]
  
  return mockData
}

// ËÆæÁΩÆÂÖ®Â±ÄÂáΩÊï∞Ôºå‰æõHTMLË°®Ê†ºÁöÑonclick‰ΩøÁî®
window.handleCellClick = handleCellClickEvent
</script>

<style scoped lang="scss">
.template-config-page {
  .card-header {
    display: flex;
    justify-content: space-between;
    align-items: center;
    margin-bottom: 16px;
    
    h3 {
      margin: 0;
      color: #303133;
      font-weight: 600;
    }
    
    .actions {
      display: flex;
      gap: 12px;
    }
  }
  
  .section {
    margin-bottom: 30px;
    border: 1px solid #e4e7ed;
    border-radius: 8px;
    overflow: hidden;
    background: white;
    box-shadow: 0 2px 6px rgba(0, 0, 0, 0.04);
    
    .section-header {
      background: linear-gradient(135deg, #667eea 0%, #764ba2 100%);
      color: white;
      padding: 16px 20px;
      cursor: pointer;
      user-select: none;
      position: relative;
      
      &:hover {
        background: linear-gradient(135deg, #5a67d8 0%, #6b46c1 100%);
      }
      
      .section-title {
        font-size: 16px;
        font-weight: 600;
        margin: 0;
      }
      
      .section-info {
        margin-top: 6px;
        font-size: 13px;
        opacity: 0.9;
        display: flex;
        align-items: center;
        gap: 16px;
        
        .info-item {
          display: flex;
          align-items: center;
          
          .el-icon {
            margin-right: 4px;
          }
        }
      }
    }
    
    .section-content {
      padding: 20px;
      
      .no-table-content {
        text-align: center;
        color: #909399;
        padding: 40px;
        
        .el-icon {
          font-size: 48px;
          color: #d3d4d6;
          margin-bottom: 12px;
        }
      }
    }
  }
  
  .table-operations {
    display: flex;
    gap: 8px;
    margin-bottom: 16px;
    flex-wrap: wrap;
    
    .el-button {
      font-size: 13px;
      padding: 6px 12px;
      
      .el-icon {
        margin-right: 4px;
      }
    }
  }

  // ÁÆÄÂåñÁâàË°®Ê†ºÊìç‰ΩúÂ∑•ÂÖ∑Ê†è
  .table-operations-simple {
    margin-bottom: 16px;
    
    .operation-buttons {
      display: flex;
      gap: 12px;
      align-items: center;
      margin-bottom: 8px;
      
      .el-button {
        font-size: 14px;
        padding: 8px 16px;
        border-radius: 6px;
        transition: all 0.2s ease;
        
        .el-icon {
          margin-right: 6px;
          
          svg {
            width: 16px;
            height: 16px;
            fill: currentColor;
          }
        }
        
        &.merge-mode-active {
          background: linear-gradient(135deg, #52c41a 0%, #73d13d 100%);
          border-color: #52c41a;
          color: white;
          
          &:hover {
            background: linear-gradient(135deg, #389e0d 0%, #52c41a 100%);
            transform: translateY(-1px);
            box-shadow: 0 4px 12px rgba(82, 196, 26, 0.3);
          }
        }
        
        &:not(.merge-mode-active):hover {
          transform: translateY(-1px);
          box-shadow: 0 4px 12px rgba(24, 144, 255, 0.3);
        }
        
        &.el-button--warning:hover {
          box-shadow: 0 4px 12px rgba(255, 193, 7, 0.3);
        }
      }
    }
    
    .operation-tips {
      font-size: 14px;
      color: #52c41a;
      background: linear-gradient(135deg, #f6ffed 0%, #d9f7be 100%);
      border: 2px solid #52c41a;
      border-radius: 6px;
      padding: 8px 16px;
      animation: fadeIn 0.3s ease, pulse-border 2s ease-in-out infinite;
      display: flex;
      align-items: center;
      box-shadow: 0 2px 8px rgba(82, 196, 26, 0.15);
      
      span {
        display: flex;
        align-items: center;
        
        &::before {
          content: 'üí°';
          margin-right: 6px;
        }
      }
    }
  }

  @keyframes fadeIn {
    from {
      opacity: 0;
      transform: translateY(-4px);
    }
    to {
      opacity: 1;
      transform: translateY(0);
    }
  }

  .table-toolbar {
    position: fixed;
    background: white;
    border: 1px solid #e4e7ed;
    border-radius: 6px;
    padding: 8px;
    box-shadow: 0 2px 12px rgba(0, 0, 0, 0.1);
    z-index: 2000;
    display: flex;
    gap: 4px;
    flex-wrap: wrap;

    .el-button {
      font-size: 12px;
      padding: 4px 8px;
      margin: 0;
      
      .el-icon {
        margin-right: 2px;
      }
    }
  }
  
  .table-section {
    .table-header {
      display: flex;
      justify-content: space-between;
      align-items: center;
      margin-bottom: 12px;
      
      h4 {
        margin: 0;
        color: #303133;
        font-size: 15px;
        font-weight: 600;
        display: flex;
        align-items: center;
        
        .el-icon {
          margin-right: 6px;
          color: #1677ff;
        }
      }
      
      .table-info {
        color: #909399;
        font-size: 12px;
        
        .el-tag {
          margin-left: 8px;
        }
      }
    }
    
    .table-actions {
      display: flex;
      gap: 8px;
      margin-bottom: 12px;
      
      .el-button {
        font-size: 12px;
        padding: 5px 10px;
        
        .el-icon {
          margin-right: 4px;
        }
      }
    }
    
    .revogrid-container {
      border: 1px solid #e8eaec;
      border-radius: 8px;
      overflow: hidden;
      background: white;
      box-shadow: 0 4px 16px rgba(0, 0, 0, 0.08);
      margin: 16px 0;
      
      // RevoGrid Áé∞‰ª£ÂåñÊ†∑Âºè - ‰øÆÂ§çËæπÊ°ÜÂíåË°®Â§¥ÂêàÂπ∂ÊòæÁ§∫
      :deep(revo-grid) {
        font-family: -apple-system, BlinkMacSystemFont, 'Segoe UI', 'Microsoft YaHei', sans-serif;
        font-size: 14px;
        border: 2px solid #e8eaec;
        position: relative;
        
        // Âº∫Âà∂ÊòæÁ§∫outline‰Ωú‰∏∫ËæπÊ°Ü
        * {
          outline: 1px solid #ddd;
          outline-offset: -1px;
        }
        
        // Âº∫Âà∂ÊòæÁ§∫ÊâÄÊúâËæπÊ°Ü
        * {
          box-sizing: border-box;
        }
        
        // Ë°®Â§¥ÂÆπÂô®
        .revo-header-viewport, 
        .revo-header {
          border-bottom: 2px solid #ddd !important;
        }
        
        // Ë°®Â§¥ÂçïÂÖÉÊ†ºÊ†∑Âºè
        .revo-header-cell,
        .header-cell,
        [data-header="true"] {
          background: linear-gradient(135deg, #667eea 0%, #764ba2 100%) !important;
          color: white !important;
          font-weight: 600;
          text-shadow: 0 1px 2px rgba(0, 0, 0, 0.1);
          border: 1px solid rgba(255, 255, 255, 0.2) !important;
          border-right: 1px solid #ddd !important;
          border-bottom: 1px solid #ddd !important;
          text-align: center;
          padding: 8px 12px;
          
          // Á°Æ‰øùÂêàÂπ∂Ë°®Â§¥ÁöÑÊòæÁ§∫
          &.group-header {
            background: linear-gradient(135deg, #4a90e2 0%, #7b68ee 100%) !important;
            border-bottom: 2px solid #333 !important;
          }
        }
        
        // Ë°®Â§¥ËæìÂÖ•Ê°ÜÊ†∑Âºè
        .header-input {
          width: 100%;
          border: none;
          background: transparent;
          color: inherit;
          font-weight: inherit;
          font-size: inherit;
          text-align: center;
          padding: 0;
          outline: none;
          
          &::placeholder {
            color: rgba(255, 255, 255, 0.7);
          }
          
          &:hover {
            background: rgba(255, 255, 255, 0.1);
          }
          
          &:focus {
            background: rgba(255, 255, 255, 0.2);
            border-radius: 2px;
          }
        }
        
        // Êï∞ÊçÆÂçïÂÖÉÊ†ºÊ†∑Âºè
        .revo-data-cell,
        .data-cell,
        [data-cell="true"] {
          border: 1px solid #e8eaec !important;
          border-right: 1px solid #ddd !important;
          border-bottom: 1px solid #ddd !important;
          padding: 8px 12px;
          background: white;
          
          &:hover {
            background-color: #e3f2fd !important;
          }
          
          // Á¨¨‰∏ÄÂàóÊ†∑Âºè
          &:first-child,
          &[data-col="0"] {
            background: linear-gradient(135deg, #f5f7fa 0%, #c3cfe2 100%) !important;
            font-weight: 600;
            text-align: center;
            color: #2c3e50;
          }
        }
        
        // Êï∞ÊçÆË°åÊ†∑Âºè
        .revo-data-row,
        .data-row,
        [data-row] {
          &:nth-child(even) {
            background-color: #f8f9fb;
          }
          
          &:hover {
            background-color: #f0f4ff !important;
          }
        }
        
        // ÁΩëÊ†ºÁ∫øÂº∫Âà∂ÊòæÁ§∫
        .revo-grid-viewport {
          border-collapse: separate !important;
          border-spacing: 0 !important;
        }
        
        // ÈÄâ‰∏≠Áä∂ÊÄÅ
        .revo-selected,
        .selected {
          background: linear-gradient(135deg, #e3f2fd 0%, #bbdefb 100%) !important;
          border: 2px solid #2196f3 !important;
          box-shadow: 0 0 0 1px rgba(33, 150, 243, 0.5);
        }
        
        // Ë°®Ê†º‰∏ª‰ΩìÂÆπÂô®ËæπÊ°Ü
        .revo-viewport,
        .revo-data-viewport {
          border: 1px solid #ddd !important;
        }
        
        // Âº∫Âà∂ÊòæÁ§∫ÂûÇÁõ¥ÂàÜÂâ≤Á∫øÂíåÊâÄÊúâËæπÊ°Ü
        revogr-data,
        revogr-header,
        revo-grid,
        .revo-grid {
          td, th, cell, div {
            border-right: 1px solid #ddd !important;
            border-bottom: 1px solid #ddd !important;
            border-left: 1px solid #ddd !important;
            border-top: 1px solid #ddd !important;
          }
        }
        
        // Âº∫Âà∂ÊòæÁ§∫Ë°®Ê†ºÂÜÖÊâÄÊúâÂçïÂÖÉÊ†ºËæπÊ°Ü
        revogr-data {
          .revo-cell,
          .cell,
          [data-cell],
          [data-col] {
            border: 1px solid #ddd !important;
            border-right: 1px solid #ddd !important;
            border-bottom: 1px solid #ddd !important;
          }
        }
        
        // Âº∫Âà∂ÊòæÁ§∫Ë°®Â§¥ËæπÊ°Ü
        revogr-header {
          .revo-header-cell,
          .header-cell,
          [data-header] {
            border: 1px solid #ddd !important;
            border-right: 1px solid #ddd !important;
            border-bottom: 1px solid #ddd !important;
          }
        }
        
        // ÈÄöÁî®ËæπÊ°ÜÊ†∑ÂºèÂº∫Âà∂Â∫îÁî®
        * {
          &[data-cell],
          &[data-header],
          &[data-col],
          &[data-row] {
            border: 1px solid #ddd !important;
          }
        }
        
        // Áõ¥Êé•‰ΩøÁî®tableËæπÊ°ÜÊ†∑ÂºèÂº∫Âà∂ÊòæÁ§∫
        table,
        tbody,
        thead,
        tr,
        td,
        th {
          border-collapse: separate !important;
          border-spacing: 0 !important;
          border: 1px solid #ddd !important;
        }
        
        // Web Components Âº∫Âà∂ËæπÊ°Ü
        revo-grid,
        revogr-data,
        revogr-header,
        revogr-overlay-selection,
        revogr-focus,
        revogr-edit,
        revogr-viewport-scroll {
          * {
            border: 1px solid #ddd !important;
          }
        }
        
        // Á°Æ‰øùÁΩëÊ†ºÁ∫øÂèØËßÅÊÄß
        .revo-grid-viewport,
        .revo-data-viewport,
        .revo-header-viewport {
          background-image: 
            linear-gradient(to right, #ddd 1px, transparent 1px),
            linear-gradient(to bottom, #ddd 1px, transparent 1px) !important;
          background-size: 120px 32px !important;
        }
        
        // ÊúÄÂº∫Âà∂ÁöÑÂûÇÁõ¥ËæπÊ°ÜÊòæÁ§∫
        revo-grid {
          // Âº∫Âà∂Ë°®Ê†ºÊ†∑Âºè
          table-layout: fixed !important;
          border-collapse: separate !important;
          border-spacing: 0 !important;
          
          // Âº∫Âà∂ÊâÄÊúâÂÖÉÁ¥†ÊòæÁ§∫ËæπÊ°Ü
          *, 
          *::before, 
          *::after {
            border-right: 1px solid #ddd !important;
            border-bottom: 1px solid #ddd !important;
            box-sizing: border-box !important;
          }
          
          // ÈíàÂØπRevoGridÂÜÖÈÉ®ÁªìÊûÑÁöÑÂº∫Âà∂Ê†∑Âºè
          revogr-viewport-scroll,
          revogr-data,
          revogr-header {
            border: 1px solid #ddd !important;
            
            // ÂÜÖÈÉ®ÊØè‰∏™cellÈÉΩË¶ÅÊúâËæπÊ°Ü
            > * {
              border-right: 1px solid #ddd !important;
              border-bottom: 1px solid #ddd !important;
            }
          }
        }
        
        // ‰ΩøÁî®CSS GridÊù•Ê®°ÊãüË°®Ê†ºËæπÊ°Ü
        revo-grid::after {
          content: '';
          position: absolute;
          top: 0;
          left: 0;
          right: 0;
          bottom: 0;
          pointer-events: none;
          background-image: 
            repeating-linear-gradient(
              0deg,
              transparent,
              transparent 31px,
              #ddd 31px,
              #ddd 32px
            ),
            repeating-linear-gradient(
              90deg,
              transparent,
              transparent 119px,
              #ddd 119px,
              #ddd 120px
            );
        }
        
        // ÊúÄÁªàËß£ÂÜ≥ÊñπÊ°àÔºö‰ΩøÁî®CSSÂèòÈáèÂíåÁ≤æÁ°ÆÈÄâÊã©Âô®
        &[style*="--grid-border"] {
          --revo-grid-border-color: #ddd !important;
        }
        
        // Âº∫Âà∂ÊòæÁ§∫ÁΩëÊ†ºÁ∫ø
        canvas {
          border: 1px solid #ddd !important;
        }
        
        // ÊúÄÂêéÁöÑÊâãÊÆµÔºö‰ΩøÁî®box-shadowÊù•Ê®°ÊãüËæπÊ°Ü
        revo-grid {
          box-shadow: 
            inset 1px 0 0 #ddd,
            inset -1px 0 0 #ddd,
            inset 0 1px 0 #ddd,
            inset 0 -1px 0 #ddd !important;
        }
        
        // ÁªàÊûÅËß£ÂÜ≥ÊñπÊ°àÔºöÁõ¥Êé•ÈíàÂØπRevoGridÁöÑÂÜÖÈÉ®ÂÖÉÁ¥†
        revogr-viewport-scroll,
        revogr-data,
        revogr-header,
        revogr-overlay-selection {
          
          // Âº∫Âà∂ÊâÄÊúâÂ≠êÂÖÉÁ¥†ÊòæÁ§∫ËæπÊ°Ü
          > * {
            position: relative;
            
            &::before {
              content: '';
              position: absolute;
              top: 0;
              right: 0;
              bottom: 0;
              left: 0;
              border: 1px solid #ddd;
              pointer-events: none;
              z-index: 1;
            }
            
            &::after {
              content: '';
              position: absolute;
              top: 0;
              right: -1px;
              bottom: 0;
              width: 1px;
              background: #ddd;
              pointer-events: none;
              z-index: 2;
            }
          }
        }
      }
    }
    
    // Âº∫Âà∂ÁΩëÊ†ºËæπÊ°ÜÁöÑÂÖ®Â±ÄÊ†∑Âºè
    .force-grid-borders {
      // ‰ΩøÁî®ÁªùÂØπÂÆö‰ΩçÁöÑË¶ÜÁõñÂ±ÇÊù•ÁªòÂà∂ÁΩëÊ†ºÁ∫ø
      position: relative;
      
      &::after {
        content: '';
        position: absolute;
        top: 0;
        left: 0;
        right: 0;
        bottom: 0;
        pointer-events: none;
        z-index: 10;
        background-image: 
          repeating-linear-gradient(
            to right,
            transparent 0px,
            transparent 119px,
            #ddd 119px,
            #ddd 120px
          ),
          repeating-linear-gradient(
            to bottom,
            transparent 0px,
            transparent 31px,
            #ddd 31px,
            #ddd 32px
          );
      }
      
      // Âº∫Âà∂ÊâÄÊúâÂÜÖÈÉ®ÂÖÉÁ¥†ÊòæÁ§∫ËæπÊ°Ü
      * {
        border: 1px solid #ddd !important;
        border-collapse: separate !important;
      }
      
      // ÈíàÂØπRevoGridÁöÑWeb Components
      revo-grid,
      revogr-viewport-scroll,
      revogr-data,
      revogr-header {
        * {
          outline: 1px solid #ddd !important;
          outline-offset: -1px !important;
        }
      }
    }
    
    .el-alert {
      :deep(.el-alert__title) {
        font-weight: 500;
      }
    }
  }

  // Áé∞‰ª£ÂåñË°®Ê†ºÊ†∑Âºè
  .modern-table-container {
    border: 1px solid #e4e7ed;
    border-radius: 8px;
    overflow: hidden;
    background: white;
    box-shadow: 0 2px 8px rgba(0, 0, 0, 0.1);
    margin: 16px 0;

    .modern-table {
      width: 100%;
      border-collapse: separate;
      border-spacing: 0;
      background: white;
      font-size: 14px;

      .table-header {
        background: #f5f7fa;
        color: #303133;
        font-weight: 600;
        text-align: center;
        padding: 16px 12px;
        border-bottom: 1px solid #e4e7ed;
        border-right: 1px solid #e4e7ed;
        height: 50px;
        
        &.merged-header {
          background: #f0f2f5;
          font-weight: 700;
        }

        &.sub-header {
          background: #fafafa;
          font-size: 13px;
        }

        &:last-child {
          border-right: none;
        }
        
        // Ë°®Â§¥ËæìÂÖ•Ê°ÜÊ†∑Âºè
        .header-input {
          width: 100%;
          border: none;
          background: transparent;
          color: inherit;
          font-weight: inherit;
          font-size: inherit;
          text-align: center;
          padding: 0;
          outline: none;
          
          &::placeholder {
            color: #909399;
            opacity: 0.7;
          }
          
          &:hover {
            background: rgba(64, 158, 255, 0.1);
            border-radius: 4px;
          }
          
          &:focus {
            background: rgba(64, 158, 255, 0.2);
            border-radius: 4px;
          }
        }
      }

      .table-cell {
        padding: 12px 16px;
        border-bottom: 1px solid #e4e7ed;
        border-right: 1px solid #e4e7ed;
        text-align: center;
        background: white;
        transition: background-color 0.2s ease;
        cursor: pointer;
        height: 44px;
        vertical-align: middle;

        &:hover {
          background: #f5f7fa;
        }
      }
      
      // Ë°®Â§¥Ë°åÊ†∑ÂºèÔºàÂíåÊôÆÈÄöÊï∞ÊçÆË°å‰øùÊåÅ‰∏ÄËá¥Ôºâ
      .header-row .table-cell {
        // ÁßªÈô§ÁâπÊÆäËÉåÊôØÔºå‰ΩøÁî®ÂíåÊï∞ÊçÆË°åÁõ∏ÂêåÁöÑÊ†∑Âºè
        
        &:last-child {
          border-right: none;
        }
      }
      
      }
      
      .header-row .table-cell {
        .cell-input {
          width: 100%;
          border: none;
          outline: none;
          background: transparent;
          padding: 8px;
          text-align: center;
          font-size: 14px;
          height: 100%;
          line-height: 1.4;
        }

        // ÂçïÂÖÉÊ†ºÈÖçÁΩÆÁä∂ÊÄÅÊ†∑Âºè
        &.cell-configured-fixed {
          background: #e6f7ff !important;
          color: #1890ff;
          font-weight: 500;
          
          &:hover {
            background: #bae7ff !important;
          }
        }

        &.cell-configured-auto {
          background: #f0f9ff !important;
          color: #52c41a;
          font-weight: 500;
          
          &:hover {
            background: #d9f7be !important;
          }
        }

        &.cell-not-configured {
          &:hover {
            background: #f5f7fa;
          }
        }

        // ÈÄâ‰∏≠Áä∂ÊÄÅÊ†∑Âºè - Ê∑ªÂä†Âä®ÊÄÅËæπÊ°ÜÊïàÊûú
        &.cell-selected {
          background: linear-gradient(135deg, #e6f7ff 0%, #d4edda 100%) !important;
          border: 2px solid #52c41a !important;
          box-shadow: 0 0 0 2px rgba(82, 196, 26, 0.2);
          position: relative;
          animation: pulse-border 1.5s ease-in-out infinite;
          
          &:hover {
            background: linear-gradient(135deg, #bae7ff 0%, #c3e6cb 100%) !important;
          }
          
          // Ê∑ªÂä†ÈÄâ‰∏≠ÊåáÁ§∫Âô®
          &::after {
            content: '';
            position: absolute;
            top: 2px;
            right: 2px;
            width: 8px;
            height: 8px;
            background: #52c41a;
            border-radius: 50%;
            box-shadow: 0 0 4px rgba(82, 196, 26, 0.5);
          }
        }

        // ÂêàÂπ∂ÂçïÂÖÉÊ†ºÊ†∑Âºè
        &.cell-merged {
          border: 2px solid #52c41a;
          background: #f6ffed;
          transition: all 0.3s ease;
          
          &:hover {
            background: #d9f7be !important;
            transform: scale(1.02);
            box-shadow: 0 4px 12px rgba(82, 196, 26, 0.3);
          }
        }
      }

      tbody tr {
        &:hover {
          background: #f9f9f9;
        }

        &:last-child .table-cell {
          border-bottom: none;
        }
      }
    }
  }

  // ÁªüËÆ°Ë°®Ê†ºÊ†∑Âºè
  .statistics-container {
    margin-top: 8px;
    border: 1px solid #1890ff;
    border-radius: 8px;
    overflow: hidden;
    background: white;
    box-shadow: 0 2px 8px rgba(24, 144, 255, 0.1);

    .statistics-table {
      width: 100%;
      border-collapse: separate;
      border-spacing: 0;
      background: white;
      font-size: 14px;

      .stats-header {
        background: linear-gradient(135deg, #1890ff 0%, #40a9ff 100%);
        color: white;
        font-weight: 600;
        text-align: center;
        padding: 14px 12px;
        border: none;
        height: 46px;
      }

      .stats-cell {
        padding: 12px 16px;
        border-right: 1px solid #91d5ff;
        text-align: center;
        background: #f0f9ff;
        cursor: pointer;
        transition: background-color 0.2s ease;
        color: #1890ff;
        font-weight: 500;
        height: 44px;
        vertical-align: middle;

        &:hover {
          background: #e6f7ff;
        }

        &:last-child {
          border-right: none;
        }
      }
    }
  }

  // ÂêàÂπ∂Ê®°ÂºèÊøÄÊ¥ªÁä∂ÊÄÅ
  .merge-mode-active {
    background: linear-gradient(135deg, #52c41a 0%, #73d13d 100%) !important;
    color: white !important;
    border-color: #52c41a !important;
    
    &:hover {
      background: linear-gradient(135deg, #389e0d 0%, #52c41a 100%) !important;
    }
  }

  // Â≠óÊÆµÂÄºÊòæÁ§∫Ê†∑Âºè
  .field-value-display {
    display: flex;
    align-items: center;
    gap: 8px;
    padding: 8px 12px;
    background: #f5f7fa;
    border: 1px solid #e4e7ed;
    border-radius: 4px;
    color: #606266;

    .el-icon {
      color: #909399;
    }
  }
  
  // Â≠óÊÆµÈ¢ÑËßàË°®Ê†ºÊ†∑Âºè
  .field-preview-table {
    .preview-note {
      margin-top: 8px;
      margin-bottom: 0;
      display: flex;
      align-items: center;
      gap: 6px;
      font-size: 12px;
      color: #909399;
      
      .el-icon {
        color: #409eff;
      }
    }
    
    :deep(.el-table) {
      margin-top: 8px;
      
      .el-table__header {
        th {
          background-color: #f0f9ff;
          color: #1890ff;
          font-weight: 600;
        }
      }
      
      .el-table__row {
        &:nth-child(even) {
          background-color: #fafafa;
        }
      }
      
      .cell {
        font-size: 12px;
      }
    }
  }
  
  /* ÂçïÊù°Êï∞ÊçÆÈ¢ÑËßàÊ†∑Âºè */
  .field-preview-single {
    .single-data-preview {
      background: #fafafa;
      border: 1px solid #e4e7ed;
      border-radius: 4px;
      padding: 12px;
      
      .field-item {
        display: flex;
        align-items: center;
        margin-bottom: 8px;
        
        &:last-child {
          margin-bottom: 0;
        }
        
        .field-label {
          font-weight: 500;
          color: #606266;
          min-width: 80px;
          flex-shrink: 0;
        }
        
        .field-value {
          color: #1890ff;
          background: #f0f9ff;
          padding: 2px 8px;
          border-radius: 3px;
          font-family: monospace;
          font-size: 12px;
        }
      }
    }
    
    .preview-note {
      margin-top: 8px;
      margin-bottom: 0;
      display: flex;
      align-items: center;
      gap: 6px;
      font-size: 12px;
      color: #909399;
      
      .el-icon {
        color: #409eff;
      }
    }
  }
  
  .field-tip {
    margin-top: 8px;
    
    .el-text {
      display: flex;
      align-items: center;
      gap: 4px;
      font-size: 12px;
      
      .el-icon {
        font-size: 14px;
      }
    }
  }
  
  /* Âä®ÁîªÂÆö‰πâ */
  @keyframes pulse-border {
    0% {
      box-shadow: 0 0 0 2px rgba(82, 196, 26, 0.2);
    }
    50% {
      box-shadow: 0 0 0 6px rgba(82, 196, 26, 0.1);
    }
    100% {
      box-shadow: 0 0 0 2px rgba(82, 196, 26, 0.2);
    }
  }
  
  @keyframes merge-highlight {
    0% {
      background: rgba(82, 196, 26, 0.05);
    }
    50% {
      background: rgba(82, 196, 26, 0.15);
    }
    100% {
      background: rgba(82, 196, 26, 0.05);
    }
  }
  
  @keyframes fadeIn {
    from {
      opacity: 0;
      transform: translateY(-10px);
    }
    to {
      opacity: 1;
      transform: translateY(0);
    }
  }
  
  /* ÂêàÂπ∂Ê®°Âºè‰∏ãÁöÑË°®Ê†ºÊ†∑Âºè */
  .merge-mode-active-table {
    td {
      cursor: crosshair !important;
      transition: all 0.2s ease;
      
      &:hover {
        background: rgba(82, 196, 26, 0.1) !important;
        border-color: #52c41a !important;
      }
    }
  }
  
  /* ÊãñÊãΩÈÄâÊã©Êó∂ÁöÑÈ¢ÑËßàÊïàÊûú */
  .cell-selecting {
    background: linear-gradient(135deg, #e6f7ff 0%, #d4edda 100%) !important;
    border: 2px dashed #52c41a !important;
    animation: merge-highlight 2s ease-in-out infinite;
  }
</style>